<!-- HTML header for doxygen 1.8.3.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta name="robots" content="noindex">
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<title>PLUMED: Master ISDD tutorial 2020: Metadynamics simulations with PLUMED</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<script>
   var redpath = "";
   
   function showPath(eg,name) {
     var i; var y = document.getElementsByName(redpath);
     for (i=0; i < y.length; i++ ) { y[i].style.color="black"; }
     var x = document.getElementsByName(name); redpath=name;
     for (i = 0; i < x.length; i++) { x[i].style.color="red"; }
     var valid="value_details_".concat(eg);
     var valueField = document.getElementById(valid);
     var dataField = document.getElementById(name);
     valueField.innerHTML = dataField.innerHTML;
   }
   function swapInput(name) {
     var btn = document.getElementById(name + "_button");
     var mydiv = document.getElementById("input_" + name);
     if( btn.textContent=="expand shortcuts" ) {
         btn.textContent = "contract shortcuts";
         var dataField = document.getElementById(name + "long");
         mydiv.innerHTML = dataField.innerHTML;
     } else if( btn.textContent=="contract shortcuts" ) {
         btn.textContent = "expand shortcuts";
         var dataField = document.getElementById(name + "short");
         mydiv.innerHTML = dataField.innerHTML;
     }
   }
</script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table align="center" frame="void" width="98%" cellpadding="2%">
<tbody>
<tr style="height: 30px;">
<td valign="center"> &nbsp; <img src="pigeon.png" width="120"/></td>
<td style="padding-left: 0.2em;" width="74%"> <a href="http://www.plumed.org"> <img src="logo.png" width="400" /> </td>
<td style="padding-left: 0.2em;" align="right"> <a href="../../developer-doc/html/index.html"> <img src="user-logo.png" width="180" /> </a> </td>
</tr>
</tbody>
</table>
<!--
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">PLUMED
   &#160;<span id="projectnumber">2.7b</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
-->
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('master-_i_s_d_d-2.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Master ISDD tutorial 2020: Metadynamics simulations with PLUMED </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="master-ISDD-2-aims"></a>
Aims</h1>
<p>The aim of this tutorial is to train users to perform and analyze metadynamics simulations with PLUMED. This tutorial has been prepared by Max Bonomi (adapting a lot of material from other tutorials) for the <a href="http://isddteach.sdv.univ-paris-diderot.fr/fr/accueil.html">Master In Silico Drug Design</a>, held at Universite' de Paris on November 25th, 2020.</p>
<h1><a class="anchor" id="master-ISDD-2-objectives"></a>
Learning Outcomes</h1>
<p>Once this tutorial is completed users will be able to:</p>
<ul>
<li>Write the PLUMED input file to perform metadynamics simulations.</li>
<li>Calculate the free energy as a function of the metadynamics collective variables.</li>
<li>Unbias metadynamics simulations.</li>
<li>Estimate the error in the reconstructed free energies using block analysis.</li>
<li>Assess the convergence of metadynamics simulations.</li>
</ul>
<h1><a class="anchor" id="master-ISDD-2-resources"></a>
Resources</h1>
<p>The <span style="background-color:yellow"><a href="tutorial-resources/master-ISDD-2.tar.gz" style="font-weight:bold" style="color:green" download="master-ISDD-2.tar.gz">TARBALL</a> </span> for this tutorial contains the following files:</p><ul>
<li><code>diala.pdb</code>: a PDB file for alanine dipeptide in vacuo.</li>
<li><code>topol.tpr</code>: a GROMACS run (binary) file to perform MD simulations of alanine dipeptide.</li>
<li><code>do_block_fes.py</code>: a python script to perform error analysis of metadynamics simulations.</li>
</ul>
<p>After dowloading the compressed archive to your local machine, you can unpack it using the following command:</p>
<pre class="fragment">tar xvzf master-ISDD-2.tar.gz
</pre><p>Once unpacked, all the files can be found in the <code>master-ISDD-2</code> directory. To keep things clean, it is recommended to run each exercise in a separate sub-directory that you can create inside <code>master-ISDD-2</code>.</p>
<dl class="section note"><dt>Note</dt><dd>This tutorial has been tested with PLUMED version 2.6.2 and GROMACS version 2019.6.</dd></dl>
<h1><a class="anchor" id="master-ISDD-2-intro"></a>
Introduction</h1>
<p>In the previous tutorial, we have seen that PLUMED can be used to compute collective variables (CVs) on a pre-calculated trajectory. However, PLUMED is most often use to add forces on the CVs during a MD simulation, for example, in order to accelerate sampling. To this aim, we have implemented a variety of possible biases acting on CVs. The complete documentation for all the biasing methods available in PLUMED can be found at the <a class="el" href="_bias.html">Bias</a> page. In the following we will learn how to use PLUMED to perform and analyze a metadynamics simulation. Here you can find a brief recap of the metadynamics theory.</p>
<p> <details> <summary> <b> To learn more: Summary of theory </b> </summary> <div class="hidden"> </p>
<p>In metadynamics, an external history-dependent bias potential is constructed in the space of a few selected degrees of freedom \( \vec{s}({q})\), generally called collective variables (CVs) <a class="el" href="citelist.html#CITEREF_metad">[67]</a>. This potential is built as a sum of Gaussian kernels deposited along the trajectory in the CVs space:</p>
<p class="formulaDsp">
\[ V(\vec{s},t) = \sum_{ k \tau &lt; t} W(k \tau) \exp\left( -\sum_{i=1}^{d} \frac{(s_i-s_i({q}(k \tau)))^2}{2\sigma_i^2} \right). \]
</p>
<p>where \( \tau \) is the Gaussian deposition stride, \( \sigma_i \) the width of the Gaussian for the \(i\)th CV, and \( W(k \tau) \) the height of the Gaussian. The effect of the metadynamics bias potential is to push the system away from local minima into visiting new regions of the phase space. Furthermore, in the long time limit, the bias potential converges to minus the free energy as a function of the CVs:</p>
<p class="formulaDsp">
\[ V(\vec{s},t\rightarrow \infty) = -F(\vec{s}) + C. \]
</p>
<p>In standard metadynamics, Gaussian kernels of constant height are added for the entire course of a simulation. As a result, the system is eventually pushed to explore high free-energy regions and the estimate of the free energy calculated from the bias potential oscillates around the real value. In well-tempered metadynamics <a class="el" href="citelist.html#CITEREF_Barducci:2008">[8]</a>, the height of the Gaussian is decreased with simulation time according to:</p>
<p class="formulaDsp">
\[ W (k \tau ) = W_0 \exp \left( -\frac{V(\vec{s}({q}(k \tau)),k \tau)}{k_B\Delta T} \right ), \]
</p>
<p>where \( W_0 \) is an initial Gaussian height, \( \Delta T \) an input parameter with the dimension of a temperature, and \( k_B \) the Boltzmann constant. With this rescaling of the Gaussian height, the bias potential smoothly converges in the long time limit, but it does not fully compensate the underlying free energy:</p>
<p class="formulaDsp">
\[ V(\vec{s},t\rightarrow \infty) = -\frac{\Delta T}{T+\Delta T}F(\vec{s}) + C. \]
</p>
<p>where \( T \) is the temperature of the system. In the long time limit, the CVs thus sample an ensemble at a temperature \( T+\Delta T \) which is higher than the system temperature \( T \). The parameter \( \Delta T \) can be chosen to regulate the extent of free-energy exploration: \( \Delta T = 0\) corresponds to standard MD, \( \Delta T \rightarrow\infty\) to standard metadynamics. In well-tempered metadynamics literature and in PLUMED, you will often encounter the term "bias factor" which is the ratio between the temperature of the CVs ( \( T+\Delta T \)) and the system temperature ( \( T \)):</p>
<p class="formulaDsp">
\[ \gamma = \frac{T+\Delta T}{T}. \]
</p>
<p>The bias factor should thus be carefully chosen in order for the relevant free-energy barriers to be crossed efficiently in the time scale of the simulation.</p>
<p>Additional information can be found in the several review papers on metadynamics <a class="el" href="citelist.html#CITEREF_gerv-laio09review">[66]</a> <a class="el" href="citelist.html#CITEREF_WCMS:WCMS31">[9]</a> <a class="el" href="citelist.html#CITEREF_WCMS:WCMS1103">[108]</a> <a class="el" href="citelist.html#CITEREF_bussi2015free">[26]</a>.</p>
<p> </div> </details> </p>
<p>We will play with a toy system, alanine dipeptide simulated in vacuo using the AMBER99SB-ILDN force field (see Fig. <a class="el" href="master-_i_s_d_d-2.html#master-ISDD-2-ala-fig">master-ISDD-2-ala-fig</a>). This rather simple molecule is useful to understand data analysis and free-energy methods. This system is a nice example because it presents two metastable states separated by a high free-energy barrier. It is conventional use to characterize the two states in terms of Ramachandran dihedral angles, which are denoted with \( \phi \) (phi) and \( \psi \) (psi) in Fig. <a class="el" href="master-_i_s_d_d-2.html#master-ISDD-2-transition-fig">master-ISDD-2-transition-fig</a>.</p>
<p><a class="anchor" id="master-ISDD-2-ala-fig"></a></p><div class="image">
<img src="belfast-2-ala.png" alt=""/>
<div class="caption">
The molecule of the day: alanine dipeptide.</div></div>
<p><a class="anchor" id="master-ISDD-2-transition-fig"></a></p><div class="image">
<img src="belfast-2-transition.png" alt=""/>
<div class="caption">
Two metastable states of alanine dipeptide are characterized by their Ramachandran dihedral angles.</div></div>
<h1><a class="anchor" id="master-ISDD-2-ex"></a>
Exercises</h1>
<h2><a class="anchor" id="master-ISDD-2-ex-1"></a>
Exercise 1: My first metadynamics simulation</h2>
<p>In this exercise we will setup and perform a well-tempered metadynamics run using the backbone dihedral \( \phi \) as collective variable. During the calculation, we will also monitor the behavior of the other backbone dihedral \( \psi \).</p>
<p>Here you can find a sample <code>plumed.dat</code> file that you can use as a template. Whenever you see an highlighted <span style="background-color:yellow">FILL</span> string, this is a string that you must replace.</p>

<div style="width: 90%; float:left" id="value_details_eg1"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.7-incomplete-yellow.svg" alt="tested on v2.7" /></div><pre style="width: 97%;" class="fragment">
<span style="color:blue"># Activate MOLINFO functionalities</span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_m_o_l_i_n_f_o.html" style="color:green">MOLINFO</a> <div class="tooltip">STRUCTURE<div class="right"><b>compulsory keyword </b>
a file in pdb format containing a reference structure. <i></i></div></div>=diala.pdb <span style="display:none;" id="eg1"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Compute the backbone dihedral angle phi, defined by atoms C-N-CA-C</span>
<span style="color:blue"># you might want to use MOLINFO shortcuts</span>
<b name="eg1phi" onclick='showPath("eg1","eg1phi")'>phi: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_t_o_r_s_i_o_n.html" style="color:green">TORSION</a> <div class="tooltip">ATOMS<div class="right">the four atoms involved in the torsional angle <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <span style="display:none;" id="eg1phi"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Compute the backbone dihedral angle psi, defined by atoms N-CA-C-N</span>
<span style="color:blue"># here also you might want to use MOLINFO shortcuts</span>
<b name="eg1psi" onclick='showPath("eg1","eg1psi")'>psi: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_t_o_r_s_i_o_n.html" style="color:green">TORSION</a> <div class="tooltip">ATOMS<div class="right">the four atoms involved in the torsional angle <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <span style="display:none;" id="eg1psi"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Activate well-tempered metadynamics in phi</span>
<b name="eg1metad" onclick='showPath("eg1","eg1metad")'>metad: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/___f_i_l_l__.html" style="color:green">__FILL__</a> <div class="tooltip">ARG<div class="right"><b> could not find this keyword </b><i></i></div></div>=<span style="background-color:yellow">__FILL__</span> 
   <span style="color:blue"># Deposit a Gaussian every 500 time steps, with initial height equal to 1.2 kJ/mol </span>
   <div class="tooltip">PACE<div class="right"><b> could not find this keyword </b><i></i></div></div>=500 <div class="tooltip">HEIGHT<div class="right"><b> could not find this keyword </b><i></i></div></div>=1.2 
   <span style="color:blue"># The bias factor should be wisely chosen </span>
   <div class="tooltip">BIASFACTOR<div class="right"><b> could not find this keyword </b><i></i></div></div>=<span style="background-color:yellow">__FILL__</span> 
   <span style="color:blue"># Gaussian width (sigma) should be chosen based on CV fluctuation in unbiased run </span>
   <div class="tooltip">SIGMA<div class="right"><b> could not find this keyword </b><i></i></div></div>=<span style="background-color:yellow">__FILL__</span> 
   <span style="color:blue"># Gaussians will be written to file and also stored on grid </span>
   <div class="tooltip">FILE<div class="right"><b> could not find this keyword </b><i></i></div></div>=HILLS <div class="tooltip">GRID_MIN<div class="right"><b> could not find this keyword </b><i></i></div></div>=-pi <div class="tooltip">GRID_MAX<div class="right"><b> could not find this keyword </b><i></i></div></div>=pi 
...<span style="display:none;" id="eg1metad"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Print both collective variables on COLVAR file every 10 steps</span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_p_r_i_n_t.html" style="color:green">PRINT</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">FILE<div class="right">the name of the file on which to output these quantities <i></i></div></div>=COLVAR <div class="tooltip">STRIDE<div class="right"><b>compulsory keyword ( default=1 )</b>
the frequency with which the quantities of interest should be output <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <span style="display:none;" id="eg1"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
</pre>
<p>The syntax for the command <a class="el" href="_m_e_t_a_d.html">METAD</a> is simple. The directive is followed by a keyword <code>ARG</code> followed by the labels of the CVs on which the metadynamics bias potential will act. The keyword <code>PACE</code> determines the stride of Gaussian deposition in number of time steps, while the keyword <code>HEIGHT</code> specifies the height of the Gaussian. For each CVs, one has to specify the width of the Gaussian by using the keyword <code>SIGMA</code>. Gaussian will be written to the file indicated by the keyword <code>FILE</code>.</p>
<p>In this example, the bias potential will be stored on a grid, whose boundaries are specified by the keywords <code>GRID_MIN</code> and <code>GRID_MAX</code>. Notice that you can provide either the number of bins for every CV (<code>GRID_BIN</code>) or the desired grid spacing (<code>GRID_SPACING</code>). In case you provide both PLUMED will use the most conservative choice (highest number of bins) for each dimension. In case you do not provide any information about bin size (neither <code>GRID_BIN</code> nor <code>GRID_SPACING</code>) and if Gaussian width is fixed, PLUMED will use 1/5 of the Gaussian width as grid spacing. This default choice should be reasonable for most applications.</p>
<p>Once your <code>plumed.dat</code> file is complete, you can run a 10-ns long metadynamics simulations with the following command:</p>
<pre class="fragment">&gt; gmx mdrun -s topol.tpr -nsteps 5000000 -plumed plumed.dat 
</pre><p>During the metadynamics simulation, PLUMED will create two files, named <code>COLVAR</code> and <code>HILLS</code>. The <code>COLVAR</code> file contains all the information specified by the <a class="el" href="_p_r_i_n_t.html">PRINT</a> command, in this case the value of the backbone dihedrals \( \phi \) and \( \psi \) every 10 steps of simulation. We can use <code>gnuplot</code> to visualize the behavior of the metadynamics CV \( \phi \) during the simulation:</p>
<pre class="fragment">gnuplot&gt; p "COLVAR" u 1:2
</pre><p><a class="anchor" id="master-ISDD-2-phi-fig"></a></p><div class="image">
<img src="munster-metad-phi.png" alt=""/>
<div class="caption">
Time evolution of the metadynamics CV during the first 2 ns of a metadynamics simulation of alanine dipeptide in vacuum.</div></div>
<p>By inspecting Figure <a class="el" href="master-_i_s_d_d-2.html#master-ISDD-2-phi-fig">master-ISDD-2-phi-fig</a>, we can see that the system is initialized in one of the two metastable states of alanine dipeptide. After a while (t=0.1 ns), the system is pushed by the metadynamics bias potential to visit the other local minimum. As the simulation continues, the bias potential fills the underlying free-energy landscape, and the system is able to diffuse in the entire phase space.</p>
<p>The <code>HILLS</code> file contains a list of the Gaussian kernels deposited along the simulation. If we give a look at the header of this file, we can find relevant information about its content:</p>
<pre class="fragment">#! FIELDS time phi sigma_phi height biasf
#! SET multivariate false
#! SET min_phi -pi
#! SET max_phi pi
</pre><p>The line starting with <code>FIELDS</code> tells us what is displayed in the various columns of the <code>HILLS</code> file: the simulation time, the instantaneous value of \( \phi \), the Gaussian width and height, and the bias factor. We can use the <code>HILLS</code> file to visualize the decrease of the Gaussian height during the simulation, according to the well-tempered recipe:</p>
<p><a class="anchor" id="master-ISDD-2-phihills-fig"></a></p><div class="image">
<img src="munster-metad-phihills.png" alt=""/>
<div class="caption">
Time evolution of the Gaussian height.</div></div>
<p>If we look carefully at the scale of the y-axis, we will notice that in the beginning the value of the Gaussian height is higher than the initial height specified in the input file, which should be 1.2 kJ/mol. In fact, this column reports the height of the Gaussian scaled by the pre-factor that in well-tempered metadynamics relates the bias potential to the free energy.</p>
<dl class="section warning"><dt>Warning</dt><dd>The fact that the Gaussian height is decreasing to zero should not be used as a measure of convergence of your metadynamics simulation!</dd></dl>
<h2><a class="anchor" id="master-ISDD-2-ex-2"></a>
Exercise 2: Estimating the free energy as a function of the metadynamics CVs</h2>
<p>One can estimate the free energy as a function of the metadynamics CVs directly from the metadynamics bias potential. In order to do so, the utility <a class="el" href="sum_hills.html">sum_hills</a> can be used to sum the Gaussian kernels deposited during the simulation and stored in the <code>HILLS</code> file. <br  />
</p>
<p>To calculate the free energy as a function of \( \phi \), it is sufficient to use the following command line:</p>
<pre class="fragment">plumed sum_hills --hills HILLS
</pre><p>The command above generates a file called <code>fes.dat</code> in which the free-energy surface as function of \( \phi \) is calculated on a regular grid. One can modify the default name for the free-energy file, as well as the boundaries and bin size of the grid, by using the following <a class="el" href="sum_hills.html">sum_hills</a> options:</p>
<pre class="fragment">--outfile - specify the outputfile for sumhills
--min - the lower bounds for the grid
--max - the upper bounds for the grid
--bin - the number of bins for the grid
--spacing - grid spacing, alternative to the number of bins
</pre><p>The result should look like this:</p>
<p><a class="anchor" id="master-ISDD-2-metad-phifes-fig"></a></p><div class="image">
<img src="munster-metad-phifes.png" alt=""/>
<div class="caption">
Estimate of the free energy as a function of the dihedral phi from a 10ns-long well-tempered metadynamics simulation.</div></div>
<p>To give a preliminary assessment of the convergence of a metadynamics simulation, one can calculate the estimate of the free energy as a function of simulation time. At convergence, the reconstructed profiles should be similar. The <a class="el" href="sum_hills.html">sum_hills</a> option <code>--stride</code> should be used to give an estimate of the free energy every <code>N</code> Gaussian kernels deposited, and the option <code>--mintozero</code> can be used to align the profiles by setting the global minimum to zero. If we use the following command line:</p>
<pre class="fragment">plumed sum_hills --hills HILLS --stride 100 --mintozero
</pre><p>one free energy is calculated every 100 Gaussian kernels deposited, and the global minimum is set to zero in all profiles. The resulting plot should look like the following:</p>
<p><a class="anchor" id="master-ISDD-2-metad-phifest-fig"></a></p><div class="image">
<img src="munster-metad-phifest.png" alt=""/>
<div class="caption">
Estimates of the free energy as a function of the dihedral phi calculated every 100 Gaussian kernels deposited.</div></div>
<p>These two qualitative observations:</p><ol type="1">
<li>the system is diffusing rapidly in the entire CV space (Figure <a class="el" href="master-_i_s_d_d-2.html#master-ISDD-2-phi-fig">master-ISDD-2-phi-fig</a>)</li>
<li>the estimated free energy does not significantly change as a function of time (Figure <a class="el" href="master-_i_s_d_d-2.html#master-ISDD-2-metad-phifest-fig">master-ISDD-2-metad-phifest-fig</a>)</li>
</ol>
<p>suggest that the simulation <b>might</b> be converged.</p>
<dl class="section warning"><dt>Warning</dt><dd>The two conditions listed above are necessary, but not sufficient to declare convergence. For a quantitative analysis of the convergence of metadynamics simulations, please have a look below at <a class="el" href="master-_i_s_d_d-2.html#master-ISDD-2-ex-4">Exercise 4: Estimating the error in free energies using block-analysis</a>.</dd></dl>
<h2><a class="anchor" id="master-ISDD-2-ex-3"></a>
Exercise 3: Reweighting (unbiasing) a metadynamics simulation</h2>
<p>In the previous exercise we biased \(\phi\) and computed the free energy as a function of the same variable directly from the metadynamics bias potential using the <a class="el" href="sum_hills.html">sum_hills</a> utility. However, in many cases you might decide which variable should be analyzed <em>after</em> having performed a metadynamics simulation. For example, you might want to calculate the free energy as a function of CVs other than those biased during the metadynamics simulation, such as the dihedral \( \psi \). At variance with standard MD simulations, you cannot simply calculate histograms of other variables directly from your metadynamics trajectory, because the presence of the metadynamics bias potential has altered the statistical weight of each frame. To remove the effect of this bias and thus be able to calculate properties of the system in the unbiased ensemble, you must reweight (unbias) your simulation.</p>
<p>There are multiple ways to calculate the correct statistical weight of each frame in your metadynamics trajectory and thus to reweight your simulation. For example:</p>
<ol type="1">
<li>weights can be calculated by considering the time-dependence of the metadynamics bias potential <a class="el" href="citelist.html#CITEREF_Tiwary_jp504920s">[110]</a>;</li>
<li>weights can be calculated using the metadynamics bias potential obtained at the end of the simulation and assuming a constant bias during the entire course of the simulation <a class="el" href="citelist.html#CITEREF_Branduardi:2012dl">[24]</a>.</li>
</ol>
<p>In this exercise we will use the second method, which resembles the umbrella-sampling reweighting approach. In order to compute the weights we will use the <a class="el" href="driver.html">driver</a> tool.</p>
<p>First of all, you need to prepare a <code>plumed_reweight.dat</code> file that is identical to the one you used for running your metadynamics simulation except for a few modifications. First, you need to add the keyword <code>RESTART=YES</code> to the <a class="el" href="_m_e_t_a_d.html">METAD</a> command. This will make this action behave as if PLUMED was restarting, i.e. PLUMED will read from the <code>HILLS</code> file the Gaussians that have previously been accumulated. Second, you need to set the Gaussian <code>HEIGHT</code> to zero and the <code>PACE</code> to a large number. This will actually avoid adding new Gaussians (and even if they are added they will have zero height). Finally, you need to modify the <a class="el" href="_p_r_i_n_t.html">PRINT</a> statement so that you write every frame and that, in addition to <code>phi</code> and <code>psi</code>, you also write <code>metad.bias</code>. You might also want to change the name of the output file to <code>COLVAR_REWEIGHT</code>.</p>

<div style="width: 90%; float:left" id="value_details_eg2"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.7-incomplete-yellow.svg" alt="tested on v2.7" /></div><pre style="width: 97%;" class="fragment">
<span style="color:blue"># Activate MOLINFO functionalities</span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_m_o_l_i_n_f_o.html" style="color:green">MOLINFO</a> <div class="tooltip">STRUCTURE<div class="right"><b>compulsory keyword </b>
a file in pdb format containing a reference structure. <i></i></div></div>=diala.pdb <span style="display:none;" id="eg2"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/___f_i_l_l__.html" style="color:green">__FILL__</a> <span style="color:blue"># here goes the definitions of the phi and psi CVs </span><span style="display:none;" id="eg2"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Activate well-tempered metadynamics in phi</span>
<b name="eg2metad" onclick='showPath("eg2","eg2metad")'>metad: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/___f_i_l_l__.html" style="color:green">__FILL__</a> <div class="tooltip">ARG<div class="right"><b> could not find this keyword </b><i></i></div></div>=<span style="background-color:yellow">__FILL__</span> 
   <span style="color:blue"># Deposit a Gaussian every 10000000 time steps (never!), with initial height equal to 0.0 kJ/mol </span>
   <div class="tooltip">PACE<div class="right"><b> could not find this keyword </b><i></i></div></div>=10000000 <div class="tooltip">HEIGHT<div class="right"><b> could not find this keyword </b><i></i></div></div>=0.0 <span style="color:blue"># &lt;- this is the new stuff! </span>
   <span style="color:blue"># The bias factor should be wisely chosen </span>
   <div class="tooltip">BIASFACTOR<div class="right"><b> could not find this keyword </b><i></i></div></div>=<span style="background-color:yellow">__FILL__</span> 
   <span style="color:blue"># Gaussian width (sigma) should be chosen based on CV fluctuation in unbiased run </span>
   <div class="tooltip">SIGMA<div class="right"><b> could not find this keyword </b><i></i></div></div>=<span style="background-color:yellow">__FILL__</span> 
   <span style="color:blue"># Gaussians will be written to file and also stored on grid </span>
   <div class="tooltip">FILE<div class="right"><b> could not find this keyword </b><i></i></div></div>=HILLS <div class="tooltip">GRID_MIN<div class="right"><b> could not find this keyword </b><i></i></div></div>=-pi <div class="tooltip">GRID_MAX<div class="right"><b> could not find this keyword </b><i></i></div></div>=pi 
   <span style="color:blue"># Say that METAD should be restarting (= reading an existing HILLS file) </span>
   <div class="tooltip">RESTART<div class="right"><b> could not find this keyword </b><i></i></div></div>=YES <span style="color:blue"># &lt;- this is the new stuff! </span>
...<span style="display:none;" id="eg2metad"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Print out the values of phi, psi and the metadynamics bias potential</span>
<span style="color:blue"># Make sure you print out the 3 variables in the specified order at every step</span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_p_r_i_n_t.html" style="color:green">PRINT</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">FILE<div class="right">the name of the file on which to output these quantities <i></i></div></div>=COLVAR_REWEIGHT <div class="tooltip">STRIDE<div class="right"><b>compulsory keyword ( default=1 )</b>
the frequency with which the quantities of interest should be output <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <span style="color:blue"># &lt;- also change this one! </span><span style="display:none;" id="eg2"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
</pre>
<p>Then run the <a class="el" href="driver.html">driver</a> tool using this command:</p>
<pre class="fragment">&gt; plumed driver --mf_xtc traj_comp.xtc --plumed plumed_reweight.dat --kt 2.494339 
</pre><p>Notice that you have to specify the value of \(k_BT\) in energy units. While running your simulation this information was communicated by the MD code.</p>
<p>As a result, PLUMED will produce a new <code>COLVAR_REWEIGHT</code> file with one additional column containing the metadynamics bias potential \( V(s) \) calculated using all the Gaussians deposited along the entire trajectory. The beginning of the file should look like this:</p>
<pre class="fragment">#! FIELDS time phi psi metad.bias
#! SET min_phi -pi
#! SET max_phi pi
#! SET min_psi -pi
#! SET max_psi pi
 0.000000 -1.497988 0.273498 110.625670
 1.000000 -1.449714 0.576594 110.873141
 2.000000 -1.209587 0.831417 109.742353
 3.000000 -1.475975 1.279726 110.752327
</pre><p>You can easily obtain the weight \( w \) of each frame using the expression \(w\propto\exp\left(\frac{V(s)}{k_BT}\right)\) (umbrella-sampling-like reweighting). At this point, you can read the <code>COLVAR_REWEIGHT</code> file using, for example, a python script and compute a weighted histogram. Alternatively, if you want PLUMED to do the weighted histograms for you, you can add the following lines at the end of the <code>plumed_reweight.dat</code> file:</p>

<div style="width: 90%; float:left" id="value_details_eg3"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.7-incomplete-yellow.svg" alt="tested on v2.7" /></div><pre style="width: 97%;" class="fragment">
<span style="color:blue"># Use the metadynamics bias as argument</span>
<b name="eg3as" onclick='showPath("eg3","eg3as")'>as: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_r_e_w_e_i_g_h_t__b_i_a_s.html" style="color:green">REWEIGHT_BIAS</a> <div class="tooltip">ARG<div class="right"><b>compulsory keyword ( default=*.bias )</b>
the biases that must be taken into account when reweighting <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <span style="display:none;" id="eg3as"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Calculate histograms of phi and psi dihedrals every 50 steps</span>
<span style="color:blue"># using the weights obtained from the metadynamics bias potentials (umbrella-sampling-like reweighting)</span>
<span style="color:blue"># Look at the manual to understand the parameters of the HISTOGRAM action!</span>
<b name="eg3hhphi" onclick='showPath("eg3","eg3hhphi")'>hhphi: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_h_i_s_t_o_g_r_a_m.html" style="color:green">HISTOGRAM</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=phi <div class="tooltip">STRIDE<div class="right"><b>compulsory keyword ( default=1 )</b>
the frequency with which the data should be collected and added to the quantity being
averaged <i></i></div></div>=50 <div class="tooltip">GRID_MIN<div class="right"><b>compulsory keyword </b>
the lower bounds for the grid <i></i></div></div>=-pi <div class="tooltip">GRID_MAX<div class="right"><b>compulsory keyword </b>
the upper bounds for the grid <i></i></div></div>=pi <div class="tooltip">GRID_BIN<div class="right">the number of bins for the grid <i></i></div></div>=50 <div class="tooltip">BANDWIDTH<div class="right"><b>compulsory keyword </b>
the bandwidths for kernel density estimation <i></i></div></div>=0.05 <div class="tooltip">LOGWEIGHTS<div class="right">list of actions that calculates log weights that should be used to weight configurations
when calculating averages <i></i></div></div>=<b name="eg3as">as</b> <span style="display:none;" id="eg3hhphi"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg3hhpsi" onclick='showPath("eg3","eg3hhpsi")'>hhpsi: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_h_i_s_t_o_g_r_a_m.html" style="color:green">HISTOGRAM</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=psi <div class="tooltip">STRIDE<div class="right"><b>compulsory keyword ( default=1 )</b>
the frequency with which the data should be collected and added to the quantity being
averaged <i></i></div></div>=50 <div class="tooltip">GRID_MIN<div class="right"><b>compulsory keyword </b>
the lower bounds for the grid <i></i></div></div>=-pi <div class="tooltip">GRID_MAX<div class="right"><b>compulsory keyword </b>
the upper bounds for the grid <i></i></div></div>=pi <div class="tooltip">GRID_BIN<div class="right">the number of bins for the grid <i></i></div></div>=50 <div class="tooltip">BANDWIDTH<div class="right"><b>compulsory keyword </b>
the bandwidths for kernel density estimation <i></i></div></div>=0.05 <div class="tooltip">LOGWEIGHTS<div class="right">list of actions that calculates log weights that should be used to weight configurations
when calculating averages <i></i></div></div>=<b name="eg3as">as</b> <span style="display:none;" id="eg3hhpsi"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Convert histograms h(s) to free energies F(s) = -kBT * log(h(s))</span>
<b name="eg3ffphi" onclick='showPath("eg3","eg3ffphi")'>ffphi: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_c_o_n_v_e_r_t__t_o__f_e_s.html" style="color:green">CONVERT_TO_FES</a> <div class="tooltip">GRID<div class="right"><b>compulsory keyword </b>
the action that creates the input grid you would like to use <i></i></div></div>=<b name="eg3hhphi">hhphi</b> <span style="display:none;" id="eg3ffphi"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg3ffpsi" onclick='showPath("eg3","eg3ffpsi")'>ffpsi: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_c_o_n_v_e_r_t__t_o__f_e_s.html" style="color:green">CONVERT_TO_FES</a> <div class="tooltip">GRID<div class="right"><b>compulsory keyword </b>
the action that creates the input grid you would like to use <i></i></div></div>=<b name="eg3hhpsi">hhpsi</b> <span style="display:none;" id="eg3ffpsi"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Print out the free energies F(s) to file once the entire trajectory is processed</span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_d_u_m_p_g_r_i_d.html" style="color:green">DUMPGRID</a> <div class="tooltip">GRID<div class="right"><b>compulsory keyword </b>
the action that creates the grid you would like to output <i></i></div></div>=<b name="eg3ffphi">ffphi</b> <div class="tooltip">FILE<div class="right"><b>compulsory keyword ( default=density )</b>
the file on which to write the grid. <i></i></div></div>=<b name="eg3ffphi">ffphi.dat</b> <span style="display:none;" id="eg3"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_d_u_m_p_g_r_i_d.html" style="color:green">DUMPGRID</a> <div class="tooltip">GRID<div class="right"><b>compulsory keyword </b>
the action that creates the grid you would like to output <i></i></div></div>=<b name="eg3ffpsi">ffpsi</b> <div class="tooltip">FILE<div class="right"><b>compulsory keyword ( default=density )</b>
the file on which to write the grid. <i></i></div></div>=<b name="eg3ffpsi">ffpsi.dat</b> <span style="display:none;" id="eg3"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
</pre>
<p>and plot the result using <code>gnuplot</code>:</p>
<pre class="fragment">gnuplot&gt; p "ffphi.dat" u 1:2 w lp
gnuplot&gt; p "ffpsi.dat" u 1:2 w lp
</pre><p>You can now compare the free energies as a function of \( \phi \) calculated:</p><ol type="1">
<li>directly from the metadynamics bias potential using <a class="el" href="sum_hills.html">sum_hills</a> as done in <a class="el" href="master-_i_s_d_d-2.html#master-ISDD-2-ex-2">Exercise 2: Estimating the free energy as a function of the metadynamics CVs</a>;</li>
<li>using the reweighting procedure introduced in this exercise.</li>
</ol>
<p>The results should be identical (see Fig. <a class="el" href="master-_i_s_d_d-2.html#master-ISDD-2-fescomp-fig">master-ISDD-2-fescomp-fig</a>).</p>
<p><a class="anchor" id="master-ISDD-2-fescomp-fig"></a></p><div class="image">
<img src="master-ISDD-2-fescomp-fig.png" alt=""/>
<div class="caption">
Comparison between the free energy as a function of the dihedral phi calculated from the metadynamics bias potential (bias) and by reweighting (rew)</div></div>
<p>.</p>
<h2><a class="anchor" id="master-ISDD-2-ex-4"></a>
Exercise 4: Estimating the error in free energies using block-analysis</h2>
<p>In the previous exercise, we calculated the <em>final</em> bias \( V(s) \) on the entire metadynamics trajectory and we used this quantity to calculate the correct statistical weight of each frame that we need to reweight the biased simulation. In this exercise, we will see how this information can be used to calculate the error in the reconstructed free energies and assess whether our simulation is converged or not. Let's first calculate the un-biasing weights \(w\propto\exp\left(\frac{V(s)}{k_BT}\right)\) from the <code>COLVAR_REWEIGHT</code> file obtained at the end of <a class="el" href="master-_i_s_d_d-2.html#master-ISDD-2-ex-3">Exercise 3: Reweighting (unbiasing) a metadynamics simulation</a>:</p>
<pre class="fragment"># Find maximum value of bias to avoid numerical errors when calculating the un-biasing weights
bmax=`awk 'BEGIN{max=0.}{if($1!="#!" &amp;&amp; $4&gt;max)max=$4}END{print max}' COLVAR_REWEIGHT`

# Print phi values and un-biasing (un-normalized) weights
awk '{if($1!="#!") print $2,exp(($4-bmax)/kbt)}' kbt=2.494339 bmax=$bmax COLVAR_REWEIGHT &gt; phi.weight
</pre><p>If you inspect the <code>phi.weight</code> file, you will see that each line contains the value of the dihedral \( \phi \) along with the corresponding (un-normalized) weight \( w \) for each frame of the metadynamics trajectory:</p>
<pre class="fragment">0.907347 0.0400579
0.814296 0.0169656
1.118951 0.0651276
1.040781 0.0714174
1.218571 0.0344903
1.090823 0.0700568
1.130800 0.0622998
</pre><p>At this point we can apply the block-analysis technique (for more info about the theory, have a look at <a class="el" href="trieste-2.html">Trieste tutorial: Averaging, histograms and block analysis</a>) to calculate the average free energy across the blocks and the error as a function of block size. For your convenience, you can use the <code>do_block_fes.py</code> python script to read the <code>phi.weight</code> file and produce the desired output. We use a bash loop to test block sizes ranging from 1 to 1000:</p>
<pre class="fragment"># Arguments of do_block_fes.py
# - input file with CV value and weight for each frame of the trajectory: phi.weight
# - number of CVs: 1
# - CV range (min, max): (-3.141593, 3.018393)
# - # points in output free energy: 51
# - kBT (kJoule/mol): 2.494339
# - Block size: 1&lt;=i&lt;=1000 (every 10)
# 
for i in `seq 1 10 1000`; do python3 do_block_fes.py phi.weight 1 -3.141593 3.018393 51 2.494339 $i; done
</pre><p>For each value of block size <code>N</code>, you will obtain a separate <code>fes.N.dat</code> file, containing the value of the \( \phi \) variable on a grid, the average free energy across the blocks with its associated error (in kJ/mol) on each point of the grid:</p>
<pre class="fragment">   -3.141593       23.184653     0.080659
   -3.018393       17.264462     0.055181
   -2.895194       13.360259     0.047751
   -2.771994       10.772696     0.043548
   -2.648794        9.403544     0.042022
</pre><p>Finally, we can calculate the average error along each free-energy profile as a function of the block size:</p>
<pre class="fragment">for i in `seq 1 10 1000`; do a=`awk '{tot+=$3}END{print tot/NR}' fes.$i.dat`; echo $i $a; done &gt; err.blocks
</pre><p>and visualize it using <code>gnuplot</code>:</p>
<pre class="fragment">gnuplot&gt; p "err.blocks" u 1:2 w lp
</pre><p>As expected, the error increases with the block size until it reaches a plateau in correspondence of a dimension of the block that exceeds the correlation between data points (Fig. <a class="el" href="master-_i_s_d_d-2.html#master-ISDD-2-block-phi">master-ISDD-2-block-phi</a>).</p>
<p><a class="anchor" id="master-ISDD-2-block-phi"></a> </p><div class="image">
<img src="trieste-4-block-phi.png" alt=""/>
<div class="caption">
Block analysis of a metadynamics simulation using phi as CV</div></div>
<p>What can we learn from this analysis about the convergence of the metadynamics simulation?</p>
<h1><a class="anchor" id="master-ISDD-2-conclusions"></a>
Conclusions</h1>
<p>In summary, in this tutorial you should have learned how to use PLUMED to:</p><ul>
<li>Setup and run a metadynamics calculation.</li>
<li>Compute free energies from the metadynamics bias potential using the <a class="el" href="sum_hills.html">sum_hills</a> utility.</li>
<li>Reweight a metadynamics simulation.</li>
<li>Calculate errors and assess convergence. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.3.1-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
<!--    <li class="navelem"><a class="el" href="tutorials.html">Tutorials</a></li>  -->
    <li class="footer">   <!--- Generated by -->
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
