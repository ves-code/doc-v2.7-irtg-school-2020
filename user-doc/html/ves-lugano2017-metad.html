<!-- HTML header for doxygen 1.8.3.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta name="robots" content="noindex">
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<title>PLUMED: MARVEL-VES tutorial (Lugano Feb 2017): Metadynamics</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<script>
   var redpath = "";
   
   function showPath(eg,name) {
     var i; var y = document.getElementsByName(redpath);
     for (i=0; i < y.length; i++ ) { y[i].style.color="black"; }
     var x = document.getElementsByName(name); redpath=name;
     for (i = 0; i < x.length; i++) { x[i].style.color="red"; }
     var valid="value_details_".concat(eg);
     var valueField = document.getElementById(valid);
     var dataField = document.getElementById(name);
     valueField.innerHTML = dataField.innerHTML;
   }
   function swapInput(name) {
     var btn = document.getElementById(name + "_button");
     var mydiv = document.getElementById("input_" + name);
     if( btn.textContent=="expand shortcuts" ) {
         btn.textContent = "contract shortcuts";
         var dataField = document.getElementById(name + "long");
         mydiv.innerHTML = dataField.innerHTML;
     } else if( btn.textContent=="contract shortcuts" ) {
         btn.textContent = "expand shortcuts";
         var dataField = document.getElementById(name + "short");
         mydiv.innerHTML = dataField.innerHTML;
     }
   }
</script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table align="center" frame="void" width="98%" cellpadding="2%">
<tbody>
<tr style="height: 30px;">
<td valign="center"> &nbsp; <img src="pigeon.png" width="120"/></td>
<td style="padding-left: 0.2em;" width="74%"> <a href="http://www.plumed.org"> <img src="logo.png" width="400" /> </td>
<td style="padding-left: 0.2em;" align="right"> <a href="../../developer-doc/html/index.html"> <img src="user-logo.png" width="180" /> </a> </td>
</tr>
</tbody>
</table>
<!--
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">PLUMED
   &#160;<span id="projectnumber">2.7b</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
-->
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('ves-lugano2017-metad.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">MARVEL-VES tutorial (Lugano Feb 2017): Metadynamics </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="ves-lugano2017-metad-lo"></a>
Learning Outcomes</h1>
<p>Once this tutorial is completed students will learn to:</p>
<ul>
<li>Perform metadynamics simulations using PLUMED 2 and LAMMPS</li>
<li>Construct a bias potential on 1 and 2 collective variables (CVs)</li>
<li>Assess the convergence of the free energy surface</li>
<li>Distinguish between good and bad CVs</li>
<li>Reweight with more than one bias potential</li>
</ul>
<h1><a class="anchor" id="ves-lugano2017-metad-resources"></a>
Resources</h1>
<p>The <a href="tutorial-resources/ves-lugano2017-metad.tar.gz" download="ves-lugano2017-metad.tar.gz">tarball </a> for this project contains the following folders:</p>
<ul>
<li>Example1 : Contains the input file for the unbiased simulation.</li>
<li>Example2 : Contains the input files for one of the biased simulations. The rest of the biased simulations inputs should be created by modifying this one.</li>
</ul>
<h1><a class="anchor" id="ves-lugano2017-metad-somesection"></a>
Instructions</h1>
<h2><a class="anchor" id="ves-lugano2017-metad-subsection-1"></a>
The system</h2>
<p>We consider the association/dissociation of NaCl in aqueous solution. The dissociation barrier is expected to be around 2.5 \(k_\mathrm{B} T\). One interesting aspect of the ion dissociation problem is that collective solvent motions play an important role in the transition. This problem has been considered in the original metadynamics paper <a class="el" href="citelist.html#CITEREF_metad">[67]</a> and also in reference <a class="el" href="citelist.html#CITEREF_tps2">[14]</a> . We will use the potential developed in ref. <a class="el" href="citelist.html#CITEREF_Pettitt-JCP-1986">[88]</a> for NaCl and TIP3P water with parameters corrected to be used with long-range Coulomb solvers <a class="el" href="citelist.html#CITEREF_Price-JCP-2004">[96]</a>. The system contains 1 Na, 1 Cl, and 106 water molecules (total 320 atoms).</p>
<p><a class="anchor" id="ves-school-2017-metad-NaCl"></a></p><div class="image">
<img src="ves-lugano2017-metad_NaCl.png" alt=""/>
<div class="caption">
NaCl in water</div></div>
<h2><a class="anchor" id="ves-lugano2017-metad-subsection-2"></a>
Perform an unbiased simulation and control the distance Na-Cl</h2>
<p>We first perform a standard MD simulation and control the distance Na-Cl. All the files needed for this example are contained in the folder Example1 . The distance Na-Cl can be calculated in Plumed 2 using: </p>
<div style="width: 90%; float:left" id="value_details_eg1"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.7-passing-green.svg" alt="tested on v2.7" /></div><pre style="width: 97%;" class="fragment">
<b name="eg1d1" onclick='showPath("eg1","eg1d1")'>d1: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_d_i_s_t_a_n_c_e.html" style="color:green">DISTANCE</a> <div class="tooltip">ATOMS<div class="right">the pair of atom that we are calculating the distance between. <i></i></div></div>=319,320 <span style="display:none;" id="eg1d1">The DISTANCE action with label <b>d1</b> calculates a single scalar value</span>
</pre>
<p>The coordination number of Na with respect to O in water will also be calculated for later use. This variable will represent the collective motion of the solvent. </p>
<div style="width: 90%; float:left" id="value_details_eg2"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.7-passing-green.svg" alt="tested on v2.7" /></div><pre style="width: 97%;" class="fragment">
<b name="eg2coord" onclick='showPath("eg2","eg2coord")'>coord: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_c_o_o_r_d_i_n_a_t_i_o_n.html" style="color:green">COORDINATION</a> ...
   <div class="tooltip">GROUPA<div class="right">First list of atoms. <i></i></div></div>=319 
   <div class="tooltip">GROUPB<div class="right">Second list of atoms (if empty, N*(N-1)/2 pairs in GROUPA are counted). <i></i></div></div>=1-318:3 
   <div class="tooltip">SWITCH<div class="right">This keyword is used if you want to employ an alternative to the continuous switching
function defined above. <i></i></div></div>={RATIONAL R_0=0.315 D_MAX=0.5 NN=12 MM=24}  
   <div class="tooltip">NLIST<div class="right">( default=off ) Use a neighbor list to speed up the calculation <i></i></div></div> 
   <div class="tooltip">NL_CUTOFF<div class="right">The cutoff for the neighbor list <i></i></div></div>=0.55 
   <div class="tooltip">NL_STRIDE<div class="right">The frequency with which we are updating the atoms in the neighbor list <i></i></div></div>=10 
   
...<span style="display:none;" id="eg2coord">The COORDINATION action with label <b>coord</b> calculates a single scalar value</span>
</pre>
<p>To run LAMMPS you can use the run.sh script: </p><pre class="fragment">#!/bin/bash

############################################################################
# Definition of variables
############################################################################
EXE=lmp_mpi
totalCores=2
############################################################################

mpirun -np ${totalCores} ${EXE} &lt; start.lmp &gt; out.lmp</pre><p>This command runs LAMMPS using 2 MPI threads. The use of partitions will be discussed when using multiple walkers</p>
<p>Once the simulation is launched, the so called COLVAR file is written. In this case it contains the following: </p><pre class="fragment">#! FIELDS time d1 coord
 0.200000 0.568067 5.506808
 0.400000 0.500148 4.994588
 0.600000 0.449778 4.931140
 0.800000 0.528272 5.105816
 1.000000 0.474371 5.089863
 1.200000 0.430620 5.091551
 1.400000 0.470374 4.993886
 1.600000 0.458768 4.940097
 1.800000 0.471886 4.952868
 2.000000 0.489058 4.897593
.
.
.
</pre><p> If you plot the time (column 1) vs the distance (column 2), for instance in gnuplot: </p><pre class="fragment">pl  "./COLVAR" u 1:2 w lp,
</pre><p> you will see that the ion pair is stuck in the dissociated state during the 1 ns simulation. It is unable to cross the \(\sim5k_\mathrm{B}T\) barrier located at a distance of approximately 0.4 nm. You can also observe this behavior in the trajectory using VMD: </p><pre class="fragment">vmd out.dcd -psf nacl.psf
</pre><p> The trajectory has been saved in unwrapped format in order to avoid bonds stretching from one side to the box to the other due to periodic boundary conditions. In VMD we can wrap the atoms without breaking the bonds and show the box using the commands: </p><pre class="fragment">pbc wrap -compound res -all
pbc box
</pre><p> You can play with different visualization styles and options that VMD has. Therefore, if we want the system to go back and forth between the associated and dissociated state, we will need enhanced sampling.</p>
<h2><a class="anchor" id="ves-lugano2017-metad-subsection-3"></a>
Construct a bias potential on the distance Na-Cl</h2>
<p>We now construct a bias potential \( V(\mathbf{s}) \) on the distance Na-Cl using well-tempered metadynamics. The files for this example are contained in the directory Example2. As argument for the construction of the potential we will use the distance Na-Cl (label d1). We choose a gaussian height of 1 kJ/mol which is slightly less than 0.5 \(k_\mathrm{B} T \). The gaussian width is 0.02 nm, in the same order of the features in the FES. A rule of thumb for choosing the gaussian width is to use the standard deviation of the unbiased fluctuations of the CV. The bias factor is set to 5 since the largest barrier in the FES is expected to be roughly 5 \(k_\mathrm{B}T\). Once the metadynamics simulation is converged, the bias will be (up to an arbitrary constant): </p><p class="formulaDsp">
\[ V(\mathbf{s})= - \left ( 1- \frac{1}{\gamma} \right ) F(\mathbf{s}) \]
</p>
<p> and therefore the system will evolve under an effective free energy: </p><p class="formulaDsp">
\[ \tilde{F}(\mathbf{s})=F(\mathbf{s})+V(\mathbf{s})= \frac{F(\mathbf{s})}{\gamma}, \]
</p>
<p> that is to say, the largest barrier will be of around 1 \(k_\mathrm{B} T\). The input is: </p>
<div style="width: 90%; float:left" id="value_details_eg3"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.7-passing-green.svg" alt="tested on v2.7" /></div><pre style="width: 97%;" class="fragment">
<b name="eg3d1" onclick='showPath("eg3","eg3d1")'>d1: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_d_i_s_t_a_n_c_e.html" style="color:green">DISTANCE</a> <div class="tooltip">ATOMS<div class="right">the pair of atom that we are calculating the distance between. <i></i></div></div>=319,320 <span style="display:none;" id="eg3d1">The DISTANCE action with label <b>d1</b> calculates a single scalar value</span>
<b name="eg3metad" onclick='showPath("eg3","eg3metad")'>metad: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_m_e_t_a_d.html" style="color:green">METAD</a> ...
   
   <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<b name="eg3d1">d1</b> 
   <div class="tooltip">SIGMA<div class="right"><b>compulsory keyword </b>
the widths of the Gaussian hills <i></i></div></div>=0.02 
   <div class="tooltip">HEIGHT<div class="right">the heights of the Gaussian hills. <i></i></div></div>=1. 
   <div class="tooltip">BIASFACTOR<div class="right">use well tempered metadynamics and use this bias factor. <i></i></div></div>=5 
   <div class="tooltip">TEMP<div class="right">the system temperature - this is only needed if you are doing well-tempered metadynamics
<i></i></div></div>=300.0 
   <div class="tooltip">PACE<div class="right"><b>compulsory keyword </b>
the frequency for hill addition <i></i></div></div>=500 
   <div class="tooltip">GRID_MIN<div class="right">the lower bounds for the grid <i></i></div></div>=0.2 
   <div class="tooltip">GRID_MAX<div class="right">the upper bounds for the grid <i></i></div></div>=1.0 
   <div class="tooltip">GRID_BIN<div class="right">the number of bins for the grid <i></i></div></div>=300 
   <div class="tooltip">CALC_RCT<div class="right">( default=off ) calculate the \f$c(t)\f$ reweighting factor and use that to obtain
the normalized bias [rbias=bias-rct].This <i></i></div></div> 
...<span style="display:none;" id="eg3metad">The METAD action with label <b>metad</b> calculates the following quantities:
<table  align="center" frame="void" width="95%%" cellpadding="5%%">
<tr><td width="5%%"><b> Quantity </b>  </td><td><b> Description </b> </td></tr>
<tr><td width="5%%">metad.bias</td><td>the instantaneous value of the bias potential</td></tr><tr><td width="5%%">metad.rbias</td><td>the instantaneous value of the bias normalized using the \f$c(t)\f$ reweighting factor [rbias=bias-rct].This component can be used to obtain a reweighted histogram.</td></tr><tr><td width="5%%">metad.rct</td><td>the reweighting factor \f$c(t)\f$.</td></tr><tr><td width="5%%">metad.work</td><td>accumulator for work</td></tr></table>
</span>
</pre>
<p> Here the CALC_RCT keyword turns on the calculation of the time dependent constant \( c(t) \) that we will use below when reweighting the simulations.</p>
<p>We will also limit the exploration of the CV space by introducing an upper wall bias \( V_{wall}(\mathbf{s}) \): </p><p class="formulaDsp">
\[ V_{wall}(s) = \kappa (s-s_0)^2 \mathrm{\: if \:} s&gt;s_0 \mathrm{ \: and \: 0 \: otherwise}. \]
</p>
<p>The wall will focus the sampling in the most interesting region of the free energy surface. The effect of this bias potential will have to be corrected later in order to calculate ensemble averages. The syntax in Plumed 2 is: </p>
<div style="width: 90%; float:left" id="value_details_eg4"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.7-passing-green.svg" alt="tested on v2.7" /></div><pre style="width: 97%;" class="fragment">
<b name="eg4d1" onclick='showPath("eg4","eg4d1")'>d1: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_d_i_s_t_a_n_c_e.html" style="color:green">DISTANCE</a> <div class="tooltip">ATOMS<div class="right">the pair of atom that we are calculating the distance between. <i></i></div></div>=319,320 <span style="display:none;" id="eg4d1">The DISTANCE action with label <b>d1</b> calculates a single scalar value</span>
<b name="eg4uwall" onclick='showPath("eg4","eg4uwall")'>uwall: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_u_p_p_e_r__w_a_l_l_s.html" style="color:green">UPPER_WALLS</a> ...
   <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<b name="eg4d1">d1</b> 
   <div class="tooltip">AT<div class="right"><b>compulsory keyword </b>
the positions of the wall. <i></i></div></div>=0.6 
   <div class="tooltip">KAPPA<div class="right"><b>compulsory keyword </b>
the force constant for the wall. <i></i></div></div>=2000.0 
   <div class="tooltip">EXP<div class="right"><b>compulsory keyword ( default=2.0 )</b>
the powers for the walls. <i></i></div></div>=2 
   <div class="tooltip">EPS<div class="right"><b>compulsory keyword ( default=1.0 )</b>
the values for s_i in the expression for a wall <i></i></div></div>=1 
   <div class="tooltip">OFFSET<div class="right"><b>compulsory keyword ( default=0.0 )</b>
the offset for the start of the wall. <i></i></div></div>=0. 
   
...<span style="display:none;" id="eg4uwall">The UPPER_WALLS action with label <b>uwall</b> calculates the following quantities:
<table  align="center" frame="void" width="95%%" cellpadding="5%%">
<tr><td width="5%%"><b> Quantity </b>  </td><td><b> Description </b> </td></tr>
<tr><td width="5%%">uwall.bias</td><td>the instantaneous value of the bias potential</td></tr><tr><td width="5%%">uwall.force2</td><td>the instantaneous value of the squared force due to this bias potential</td></tr></table>
</span>
</pre>
<p>You can run the simulation with the run.sh script as done in the previous example.</p>
<p>It is possible to try different bias factors to check the effect that it has on the trajectory and the effective FES.</p>
<p>In principle the cost of a metadynamics simulation should increase as the simulation progresses due to the need of adding an increasing number of Gaussian kernels to calculate the bias. However, since a grid is used to build up the bias this effect is not observed. You can check what happens if you do not use the GRID_* keywords. Remember that the bins in the grid should be small enough to describe the changes in the bias created by the Gaussian kernels. Normally a bin of size \( \sigma / 5 \) (with \( \sigma \) the gaussian width) is small enough.</p>
<h2><a class="anchor" id="ves-lugano2017-metad-subsection-4"></a>
Assess convergence</h2>
<p>One way to identify if a well tempered metadynamics simulation has converged is observing the estimated free energy surface at different times. The FES is estimated by using the relation (again up to an arbitrary constant): </p><p class="formulaDsp">
\[ F(\mathbf{s}) = - \left ( \frac{\gamma}{\gamma-1} \right ) V(\mathbf{s},t) \]
</p>
<p> and the bias potential is calculated as a sum of Gaussian kernels. This can be done with Plumed 2 using for instance: </p><pre class="fragment">plumed sum_hills --hills ../HILLS --min 0.1 --max 0.8 --bin 300 --stride 100
</pre><p> Most of the flags are self explanatory. The flag &ndash;stride 100 will result in the FES been written every 100 Gaussian kernels, i.e. 100 ps. Inside the folder FES_calculation you will find a script run.sh that executes the sum_hills command and a gnuplot script plot.gpi that can be used typing:. </p><pre class="fragment">gnuplot plot.gpi
</pre><p> After roughly 3 ns the free energy surface does not change significantly with time except for an immaterial constant \( c(t) \) that grows in time. This is in line with well-tempered metadynamics asymptotic behavior: </p><p class="formulaDsp">
\[ V(\mathbf{s},t)= - \left ( 1- \frac{1}{\gamma} \right ) F(\mathbf{s}) + c(t). \]
</p>
<p> The behavior of \( c(t) \) will be studied with greater detail later. <a class="anchor" id="ves-school-2017-metad-fesEvolution"></a></p><div class="image">
<img src="ves-lugano2017-metad_fesEvolution.png" alt=""/>
<div class="caption">
Evolution of the estimated free energy</div></div>
<p>It should be stressed that we are actually not calculating the free energy \( F(\mathbf{s}) \) but rather \( F(\mathbf{s})+V_{wall}(\mathbf{s}) \). For this reason for distances higher than 0.6 nm the free energy increases sharply.</p>
<p>An alternative way to observe the evolution of the bias is plotting the final free energy plus the instantaneous bias. The scripts for this example can be found in the folder Bias_calculation. In this case we observe only the first 200 ps of the simulation. The (negative) bias can be calculated using: </p><pre class="fragment">plumed sum_hills --hills ../HILLS --min 0.1 --max 0.8 --bin 300 --stride 10 --negbias
</pre><p> This plot illustrates clearly how the bias is constructed to progressively "fill" the FES. <a class="anchor" id="ves-school-2017-metad-biasEvolution"></a></p><div class="image">
<img src="ves-lugano2017-metad_biasEvolution.png" alt=""/>
<div class="caption">
Evolution of the bias potential</div></div>
<p>It is also possible to track convergence by controlling the evolution of some quantity connected to the free energy surface. In this case we will calculate the dissociation barrier, e.g. the height of the barrier that separates the associated state from the dissociated one. The scripts for this example are found in the folder Barrier_calculation. Using the python script calculate_barrier.py we can compute the barrier, for instance: </p><div class="fragment"><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Total number of fes files in folder</span></div>
<div class="line">total_files=101</div>
<div class="line"><span class="comment"># Min and max initial guesses</span></div>
<div class="line">min_min=50</div>
<div class="line">min_max=90</div>
<div class="line">max_min=90</div>
<div class="line">max_max=130</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(total_files):</div>
<div class="line">        file_name=<span class="stringliteral">&quot;fes_&quot;</span> + str(i) + <span class="stringliteral">&quot;.dat&quot;</span></div>
<div class="line">        matrix=np.genfromtxt(file_name)</div>
<div class="line">        minimum=np.amin(matrix[min_min:min_max,1])</div>
<div class="line">        maximum=np.amax(matrix[max_min:max_max,1])</div>
<div class="line">        print(str(i) + <span class="stringliteral">&quot; &quot;</span> + str(minimum) + <span class="stringliteral">&quot; &quot;</span> + str(maximum) + <span class="stringliteral">&quot; &quot;</span> + str(maximum-minimum))</div>
</div><!-- fragment --><p>The script can be executed using: </p><pre class="fragment">python barrier_calculation.py &gt; barrier.txt
</pre><p> and the results can be plotted using the gnuplot script plot.gpi. After roughly 4 ns the barrier stabilizes around 3 and 3.5 \(k_\mathrm{B} T\). <a class="anchor" id="ves-school-2017-metad-barrier"></a></p><div class="image">
<img src="ves-lugano2017-metad_barrier.png" alt=""/>
<div class="caption">
Dissociation barrier as a function of simulation time</div></div>
<p>It is important to stress that it is only possible to calculate the free energy difference between two points if the system has gone back and forth between these points several times. This applies both for the calculation of a barrier and the difference in free energy between two basins. It is also important to understand that none of the free energy methods described in this series of tutorials will be able to calculate free energies of regions that have not been sampled, i.e. visited.</p>
<p>Reweighting the simulation on the same CV that was used for biasing can also be used as a test of convergence. We will show that in the next section.</p>
<h2><a class="anchor" id="ves-lugano2017-metad-subsection-5"></a>
Reweight the simulation</h2>
<p>We first reweight the simulation on the distance Na-Cl, the same CV used for biasing. This reweighting is useful to check convergence and to have an estimate of the free energy that does not rely on using kernels. For instance if some features of the FES could not be captured by the kernels, the reweighting procedure will show them. This will become clearer in the VES tutorial. The scripts to perform this calculation are found in the folder ReweightDistance. In metadynamics quasi-stationary limit the weight assigned to a given configuration is <a class="el" href="citelist.html#CITEREF_Tiwary_jp504920s">[110]</a> : </p><p class="formulaDsp">
\[ w(\mathbf{R}) \propto e^{\beta ( V(\mathbf{s},t) - c(t) )}. \]
</p>
<p> By plotting time (column 1) versus \( c(t) \) (column 6) using the COLVAR file, the importance of taking \( c(t) \) into account becomes clear. \( c(t) \) keeps growing even after long times, reflecting the approximately rigid shift of the bias with time. Normally the first part of the trajectory is not used for reweighting since during this period the simulation has not reached the quasi-stationary limit. In this case we can discard the first 2 or 3 ns of simulation. To disregard the first 3 ns of simulation we can use sed to delete the first 15000 lines from the COLVAR file: </p><pre class="fragment">sed '2,15000d' ../COLVAR &gt; COLVAR
</pre><p>We then use Plumed to calculate two histograms, one taking into account the wall bias and the other one neglecting it. The weights for the reweighting involving only the metadynamics bias have already been discussed while the weights considering both biases are: </p><p class="formulaDsp">
\[ w(\mathbf{R}) \propto e^{\beta ( V(\mathbf{s},t) - c(t) + V_{wall}(\mathbf{s}) )}. \]
</p>
<p> The header of the COLVAR file should be: </p><pre class="fragment">#! FIELDS time d1 coord metad.bias metad.rbias metad.rct metad.work uwall.bias
</pre><p> The input script for Plumed is: </p>
<div style="width: 90%; float:left" id="value_details_eg5"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.7-passing-green.svg" alt="tested on v2.7" /></div><pre style="width: 97%;" class="fragment">
<span style="color:blue"># Read COLVAR file</span>
<b name="eg5distance" onclick='showPath("eg5","eg5distance")'>distance: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_r_e_a_d.html" style="color:green">READ</a> <div class="tooltip">FILE<div class="right"><b>compulsory keyword </b>
the name of the file from which to read these quantities <i></i></div></div>=COLVAR <div class="tooltip">IGNORE_TIME<div class="right">( default=off ) ignore the time in the colvar file. <i></i></div></div> <div class="tooltip">VALUES<div class="right"><b>compulsory keyword </b>
the values to read from the file <i></i></div></div>=d1 <span style="display:none;" id="eg5distance">The READ action with label <b>distance</b> calculates a single scalar value</span>
<b name="eg5metad" onclick='showPath("eg5","eg5metad")'>metad: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_r_e_a_d.html" style="color:green">READ</a> <div class="tooltip">FILE<div class="right"><b>compulsory keyword </b>
the name of the file from which to read these quantities <i></i></div></div>=COLVAR <div class="tooltip">IGNORE_TIME<div class="right">( default=off ) ignore the time in the colvar file. <i></i></div></div> <div class="tooltip">VALUES<div class="right"><b>compulsory keyword </b>
the values to read from the file <i></i></div></div>=<b name="eg5metad">metad.rbias</b> <span style="display:none;" id="eg5metad">The READ action with label <b>metad</b> calculates a single scalar value</span>
<b name="eg5uwall" onclick='showPath("eg5","eg5uwall")'>uwall: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_r_e_a_d.html" style="color:green">READ</a> <div class="tooltip">FILE<div class="right"><b>compulsory keyword </b>
the name of the file from which to read these quantities <i></i></div></div>=COLVAR <div class="tooltip">IGNORE_TIME<div class="right">( default=off ) ignore the time in the colvar file. <i></i></div></div> <div class="tooltip">VALUES<div class="right"><b>compulsory keyword </b>
the values to read from the file <i></i></div></div>=<b name="eg5uwall">uwall.bias</b> <span style="display:none;" id="eg5uwall">The READ action with label <b>uwall</b> calculates a single scalar value</span>
<span style="color:blue"># Define weights</span>
<b name="eg5weights1" onclick='showPath("eg5","eg5weights1")'>weights1: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_r_e_w_e_i_g_h_t__m_e_t_a_d.html" style="color:green">REWEIGHT_METAD</a> <div class="tooltip">TEMP<div class="right">the system temperature. <i></i></div></div>=300 <span style="display:none;" id="eg5weights1">The REWEIGHT_METAD action with label <b>weights1</b> calculates a single scalar value</span>
<b name="eg5weights2" onclick='showPath("eg5","eg5weights2")'>weights2: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_r_e_w_e_i_g_h_t__b_i_a_s.html" style="color:green">REWEIGHT_BIAS</a> <div class="tooltip">TEMP<div class="right">the system temperature. <i></i></div></div>=300 <div class="tooltip">ARG<div class="right"><b>compulsory keyword ( default=*.bias )</b>
the biases that must be taken into account when reweighting <i></i></div></div>=<b name="eg5metad">metad.rbias</b>,<b name="eg5uwall">uwall.bias</b> <span style="display:none;" id="eg5weights2">The REWEIGHT_BIAS action with label <b>weights2</b> calculates a single scalar value</span>
<span style="color:blue"># Calculate histograms</span>
<b name="eg5hh1" onclick='showPath("eg5","eg5hh1")'>hh1: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_h_i_s_t_o_g_r_a_m.html" style="color:green">HISTOGRAM</a> ...
   <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<b name="eg5distance">distance</b> 
   <div class="tooltip">GRID_MIN<div class="right"><b>compulsory keyword </b>
the lower bounds for the grid <i></i></div></div>=0.2 
   <div class="tooltip">GRID_MAX<div class="right"><b>compulsory keyword </b>
the upper bounds for the grid <i></i></div></div>=0.8 
   <div class="tooltip">GRID_BIN<div class="right">the number of bins for the grid <i></i></div></div>=100 
   <div class="tooltip">BANDWIDTH<div class="right"><b>compulsory keyword </b>
the bandwidths for kernel density estimation <i></i></div></div>=0.002 
   <div class="tooltip">LOGWEIGHTS<div class="right">list of actions that calculates log weights that should be used to weight configurations
when calculating averages <i></i></div></div>=<b name="eg5weights1">weights1</b> 
   
...<span style="display:none;" id="eg5hh1">The HISTOGRAM action with label <b>hh1</b></span>
<b name="eg5hh2" onclick='showPath("eg5","eg5hh2")'>hh2: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_h_i_s_t_o_g_r_a_m.html" style="color:green">HISTOGRAM</a> ...
   <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<b name="eg5distance">distance</b> 
   <div class="tooltip">GRID_MIN<div class="right"><b>compulsory keyword </b>
the lower bounds for the grid <i></i></div></div>=0.2 
   <div class="tooltip">GRID_MAX<div class="right"><b>compulsory keyword </b>
the upper bounds for the grid <i></i></div></div>=0.8 
   <div class="tooltip">GRID_BIN<div class="right">the number of bins for the grid <i></i></div></div>=100 
   <div class="tooltip">BANDWIDTH<div class="right"><b>compulsory keyword </b>
the bandwidths for kernel density estimation <i></i></div></div>=0.002 
   <div class="tooltip">LOGWEIGHTS<div class="right">list of actions that calculates log weights that should be used to weight configurations
when calculating averages <i></i></div></div>=<b name="eg5weights2">weights2</b> 
   
...<span style="display:none;" id="eg5hh2">The HISTOGRAM action with label <b>hh2</b></span>
<span style="color:blue"># Print histograms to file</span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_d_u_m_p_g_r_i_d.html" style="color:green">DUMPGRID</a> <div class="tooltip">GRID<div class="right"><b>compulsory keyword </b>
the action that creates the grid you would like to output <i></i></div></div>=<b name="eg5hh1">hh1</b> <div class="tooltip">FILE<div class="right"><b>compulsory keyword ( default=density )</b>
the file on which to write the grid. <i></i></div></div>=histo <div class="tooltip">FMT<div class="right">the format that should be used to output real numbers <i></i></div></div>=%24.16e <span style="display:none;" id="eg5">The DUMPGRID action with label <b></b></span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_d_u_m_p_g_r_i_d.html" style="color:green">DUMPGRID</a> <div class="tooltip">GRID<div class="right"><b>compulsory keyword </b>
the action that creates the grid you would like to output <i></i></div></div>=<b name="eg5hh2">hh2</b> <div class="tooltip">FILE<div class="right"><b>compulsory keyword ( default=density )</b>
the file on which to write the grid. <i></i></div></div>=histo_wall <div class="tooltip">FMT<div class="right">the format that should be used to output real numbers <i></i></div></div>=%24.16e <span style="display:none;" id="eg5">The DUMPGRID action with label <b></b></span>
</pre>
<p>This example can be run with: </p><pre class="fragment">plumed --no-mpi driver --plumed plumed.dat --noatoms &gt; plumed.out
</pre><p> and will generate the files histo and histo_wall. The histograms represent the probability \(p(\mathbf{s})\) of observing a given value of the CV \( \mathbf{s} \) . From the histograms the FES can be calculated using: </p><p class="formulaDsp">
\[ \beta F(\mathbf{s})= - \log p(\mathbf{s}) \]
</p>
<p> and therefore we plot the FES in gnuplot using for instance: </p><pre class="fragment">pl  "./histo" u 1:(-log($2)) w lp
</pre><p>The next plot compares the estimations of the FES from sum_hills, reweighting with metadynamics bias, and reweighting using both the metadynamics bias and the upper wall bias You will find a gnuplot script plot.gpi to make this plot inside the ReweightDistance folder.</p>
<p><a class="anchor" id="ves-school-2017-metad-reweightDist"></a></p><div class="image">
<img src="ves-lugano2017-metad_reweightDist.png" alt=""/>
<div class="caption">
FES estimated from sum_hills, reweighting using only the metadynamics bias, and reweighting using both the metadynamics bias and the upper wall bias</div></div>
<p>We can obtain important information of the system by reweighting on 2 CVs: The distance Na-Cl and the coordination of Na with O. This reweighting is similar to the one already done and the files that you will need are located in the ReweightBoth folder. Additionally the COLVAR file with the omitted first steps is required. The plot of the FES as a function of these 2 CVs provides important information of the association/dissociation mechanism. In the dissociated state, Na can have a coordination of 5 or 6, though it is more likely to find a coordination number of 6. However, in order to associate Na must have a coordination with O of 5. In the associated state Na can have a coordination of 3, 4 or 5. The transition state is characterized by a coordination number of ~5.</p>
<p><a class="anchor" id="ves-school-2017-metad-reweightBoth"></a></p><div class="image">
<img src="ves-lugano2017-metad_reweightBoth.png" alt=""/>
<div class="caption">
Free energy as a function of distance Na-Cl and the coordination number of Na and O.</div></div>
<h2><a class="anchor" id="ves-lugano2017-metad-subsection-6"></a>
Construct a bias potential on the coordination Na-O</h2>
<p>As an exercise, you can write the input files for a simulation in which a bias potential is constructed on the coordination Na-0, i.e. the solvent degree of freedom. You can use the same gaussian height as before and \( \sigma = 0.1 \).</p>
<p>You will find that the exploration of the CV space is not efficient. The reason is that there is a slow degree of freedom that it is not being biased: the distance Na-Cl. Furthermore you can see in the 2 CV reweighting that the coordination Na-O shows significant overlap between the associated and dissociated states.</p>
<p>Bear in mind that this is a rather trivial example since the existing barriers are relatively low. Real problems in materials science usually involve large barriers and are not as forgiving as this example; a bad CV may lead to huge hysteresis and problems in convergence.</p>
<h2><a class="anchor" id="ves-lugano2017-metad-subsection-7"></a>
Construct a bias potential on both CVs</h2>
<p>We will now construct a bias potential on both CVs. We have already calculated the FES as a function of both CVs through reweighting. In this example the FES will be calculated using the metadynamics bias potential. You can use the input files from Example2.tar and changed the plumed.dat file. To construct a 2 dimensional bias with metadynamics use the following input: </p>
<div style="width: 90%; float:left" id="value_details_eg6"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.7-incomplete-yellow.svg" alt="tested on v2.7" /></div><pre style="width: 97%;" class="fragment">
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/___f_i_l_l__.html" style="color:green">__FILL__</a> <span style="display:none;" id="eg6"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg6metad" onclick='showPath("eg6","eg6metad")'>metad: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_m_e_t_a_d.html" style="color:green">METAD</a> ...
   
   <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=d1,coord 
   <div class="tooltip">SIGMA<div class="right"><b>compulsory keyword </b>
the widths of the Gaussian hills <i></i></div></div>=0.02,0.1 
   <div class="tooltip">HEIGHT<div class="right">the heights of the Gaussian hills. <i></i></div></div>=1. 
   <div class="tooltip">BIASFACTOR<div class="right">use well tempered metadynamics and use this bias factor. <i></i></div></div>=5 
   <div class="tooltip">TEMP<div class="right">the system temperature - this is only needed if you are doing well-tempered metadynamics
<i></i></div></div>=300.0 
   <div class="tooltip">PACE<div class="right"><b>compulsory keyword </b>
the frequency for hill addition <i></i></div></div>=500 
   <div class="tooltip">GRID_MIN<div class="right">the lower bounds for the grid <i></i></div></div>=0.15,2. 
   <div class="tooltip">GRID_MAX<div class="right">the upper bounds for the grid <i></i></div></div>=0.9,9. 
   <div class="tooltip">GRID_BIN<div class="right">the number of bins for the grid <i></i></div></div>=400,400 
   <div class="tooltip">CALC_RCT<div class="right">( default=off ) calculate the \f$c(t)\f$ reweighting factor and use that to obtain
the normalized bias [rbias=bias-rct].This <i></i></div></div> 
...<span style="display:none;" id="eg6metad"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
</pre>
<p>Once that the simulation is completed you can run plumed sum_hills to calculate the FES: </p><pre class="fragment">plumed sum_hills --hills HILLS --mintozero
</pre><p> and plot the results using the following lines in gnuplot: </p><pre class="fragment">set pm3d map
set zr [0:15]
spl "fes.dat" u 1:2:3
</pre> <h1><a class="anchor" id="ves-lugano2017-metad-final"></a>
Final remarks</h1>
<p>Some valuable tools for metadynamics simulations will be discussed in the VES tutorial. These include:</p>
<ul>
<li>Restarting a simulation.</li>
<li>Using Plumed driver to calculate a CV that was not calculated during the simulation. A reweighting can then be performed on this CV.</li>
<li>Constructing biased histograms, i.e. histograms without weights to calculate the effective FES \( \tilde{F}(\mathbf{s}) = F(\mathbf{s}) + V(\mathbf{s}) \).</li>
<li>Use multiple walkers to improve the exploration of CV space. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.3.1-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
<!--    <li class="navelem"><a class="el" href="_add_mod.html">Additional Modules</a></li><li class="navelem"><a class="el" href="_v_e_s.html">Variationally Enhanced Sampling (VES code)</a></li><li class="navelem"><a class="el" href="ves_tutorials.html">Tutorials</a></li>  -->
    <li class="footer">   <!--- Generated by -->
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
