<!-- HTML header for doxygen 1.8.3.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta name="robots" content="noindex">
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<title>PLUMED: Optimizing PLUMED performance</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<script>
   var redpath = "";
   
   function showPath(eg,name) {
     var i; var y = document.getElementsByName(redpath);
     for (i=0; i < y.length; i++ ) { y[i].style.color="black"; }
     var x = document.getElementsByName(name); redpath=name;
     for (i = 0; i < x.length; i++) { x[i].style.color="red"; }
     var valid="value_details_".concat(eg);
     var valueField = document.getElementById(valid);
     var dataField = document.getElementById(name);
     valueField.innerHTML = dataField.innerHTML;
   }
   function swapInput(name) {
     var btn = document.getElementById(name + "_button");
     var mydiv = document.getElementById("input_" + name);
     if( btn.textContent=="expand shortcuts" ) {
         btn.textContent = "contract shortcuts";
         var dataField = document.getElementById(name + "long");
         mydiv.innerHTML = dataField.innerHTML;
     } else if( btn.textContent=="contract shortcuts" ) {
         btn.textContent = "expand shortcuts";
         var dataField = document.getElementById(name + "short");
         mydiv.innerHTML = dataField.innerHTML;
     }
   }
</script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table align="center" frame="void" width="98%" cellpadding="2%">
<tbody>
<tr style="height: 30px;">
<td valign="center"> &nbsp; <img src="pigeon.png" width="120"/></td>
<td style="padding-left: 0.2em;" width="74%"> <a href="http://www.plumed.org"> <img src="logo.png" width="400" /> </td>
<td style="padding-left: 0.2em;" align="right"> <a href="../../developer-doc/html/index.html"> <img src="user-logo.png" width="180" /> </a> </td>
</tr>
</tbody>
</table>
<!--
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">PLUMED
   &#160;<span id="projectnumber">2.7b</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
-->
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('performance-optimization.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Optimizing PLUMED performance </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><dl class="section author"><dt>Authors</dt><dd>Giovanni Bussi </dd></dl>
<dl class="section date"><dt>Date</dt><dd>February 19, 2019</dd></dl>
<p>This document describes the PLUMED tutorial held at CINECA, February 2019. The aim of this tutorial is to learn how to optimize simulations performed using PLUMED. Although the presented input files are correct, the users are invited to <b>refer to the literature to understand how the parameters of enhanced sampling methods should be chosen in a real application.</b></p>
<p>Users are also encouraged to follow the links to the full PLUMED reference documentation and to wander around in the manual to discover the many available features and to do the other, more complete, tutorials.</p>
<h1><a class="anchor" id="performance-optimization-2-optimization"></a>
How to optimize a simulation performed with PLUMED</h1>
<p>The input files for this exercise can be found in this <span style="background-color:yellow"><a href="tutorial-resources/performance-optimization.tar.gz" style="font-weight:bold" style="color:green" download="performance-optimization.tar.gz">TARBALL</a> </span>.</p>
<p>We will now learn how to optimize a simulation where PLUMED is used on-the-fly to compute or bias collective variables. You should use the provided <code>topol.tpr</code> file.</p>
<h2><a class="anchor" id="performance-optimization-2a"></a>
Run a simulation with GROMACS alone</h2>
<p>In order to run a simulation with gromacs you can use the following command </p><pre class="fragment">gmx_mpi mdrun -nsteps 500 -v -nb cpu -ntomp 12 -pin on
</pre><p> This will run a simulation for 500 steps, without using any GPU-acceleration, and with 12 OpenMP threads. Later at the end of the tutorial we will see how the speed of GROMACS+PLUMED changes when using the GPU. Adjust the number of threads based on the number of processors that you have on each node. 500 steps should be sufficient to get an estimate of the simulation speed if you use OpenMP only. Notice that if you use MPI parallelism with GROMACS more steps are needed due to dynamic load balancing.</p>
<p>As a first step, make a table showing the performance (ns per day) with different number of OpenMP threads. On my workstation the result is</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Number of threads </th><th class="markdownTableHeadCenter">Performance (ns/day) </th><th class="markdownTableHeadCenter">Wallclock time (s)  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">12 </td><td class="markdownTableBodyCenter">27.225 </td><td class="markdownTableBodyCenter">3.180  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">6 </td><td class="markdownTableBodyCenter">12.677 </td><td class="markdownTableBodyCenter">6.829  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">3 </td><td class="markdownTableBodyCenter">8.827 </td><td class="markdownTableBodyCenter">9.807  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">1 </td><td class="markdownTableBodyCenter">3.685 </td><td class="markdownTableBodyCenter">23.491  </td></tr>
</table>
<p>Scaling is approximately linear.</p>
<h2><a class="anchor" id="performance-optimization-2b"></a>
Run a simulation with GROMACS+PLUMED</h2>
<p>Now you can run GROMACS with PLUMED using the following input file</p>

<div style="width: 90%; float:left" id="value_details_eg1"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.7-failed-red.svg" alt="tested on v2.7" /></div><pre style="width: 97%;" class="fragment">
<span style="color:blue">#SETTINGS MOLFILE=regtest/basic/rt32/helix.pdb</span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_m_o_l_i_n_f_o.html" style="color:green">MOLINFO</a> <div class="tooltip">STRUCTURE<div class="right"><b>compulsory keyword </b>
a file in pdb format containing a reference structure. <i></i></div></div>=conf.pdb <span style="display:none;" id="eg1"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># @water and @hydrogens are special groups introduce in PLUMED 2.5!</span>
<b name="eg1wat" onclick='showPath("eg1","eg1wat")'>wat: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_g_r_o_u_p.html" style="color:green">GROUP</a> <div class="tooltip">ATOMS<div class="right">the numerical indexes for the set of atoms in the group. <i></i></div></div>=@water <span style="display:none;" id="eg1wat"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg1ow" onclick='showPath("eg1","eg1ow")'>ow: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_g_r_o_u_p.html" style="color:green">GROUP</a> <div class="tooltip">ATOMS<div class="right">the numerical indexes for the set of atoms in the group. <i></i></div></div>=@water <div class="tooltip">REMOVE<div class="right">remove these atoms from the list. <i></i></div></div>=@hydrogens <span style="display:none;" id="eg1ow"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg1mg" onclick='showPath("eg1","eg1mg")'>mg: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_g_r_o_u_p.html" style="color:green">GROUP</a> <div class="tooltip">ATOMS<div class="right">the numerical indexes for the set of atoms in the group. <i></i></div></div>=10484 <span style="display:none;" id="eg1mg"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg1p" onclick='showPath("eg1","eg1p")'>p: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_g_r_o_u_p.html" style="color:green">GROUP</a> <div class="tooltip">ATOMS<div class="right">the numerical indexes for the set of atoms in the group. <i></i></div></div>=@P-2 <span style="display:none;" id="eg1p"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg1dp" onclick='showPath("eg1","eg1dp")'>dp: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_d_i_s_t_a_n_c_e.html" style="color:green">DISTANCE</a> <div class="tooltip">ATOMS<div class="right">the pair of atom that we are calculating the distance between. <i></i></div></div>=<b name="eg1mg">mg</b>,<b name="eg1p">p</b> <span style="display:none;" id="eg1dp"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg1cn" onclick='showPath("eg1","eg1cn")'>cn: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_c_o_o_r_d_i_n_a_t_i_o_n.html" style="color:green">COORDINATION</a> <div class="tooltip">GROUPA<div class="right">First list of atoms. <i></i></div></div>=<b name="eg1mg">mg</b> <div class="tooltip">GROUPB<div class="right">Second list of atoms (if empty, N*(N-1)/2 pairs in GROUPA are counted). <i></i></div></div>=<b name="eg1ow">ow</b> <div class="tooltip">R_0<div class="right"><b> could not find this keyword </b><i></i></div></div>=0.261 <span style="display:none;" id="eg1cn"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_p_r_i_n_t.html" style="color:green">PRINT</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<b name="eg1dp">dp</b>,<b name="eg1cn">cn</b> <span style="display:none;" id="eg1"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
</pre>
<p>The command to run the simulation will be </p><pre class="fragment">gmx_mpi mdrun -nsteps 500 -v -nb cpu -ntomp 12 -pin on -plumed plumed.dat
</pre><p>The total time required by this simulation should <b>increase</b>. This is because PLUMED occupies some of the CPU cycles in order to:</p><ul>
<li>copy the coordinates of the requested atoms</li>
<li>compute the requested collective variables</li>
<li>print them on a file</li>
</ul>
<p>Take note of the increment in the wall-clock time. On my workstation it is approx 1.5 seconds more for these 500 steps with 12 OpenMP threads. Check how much is the impact when you change the number of threads.</p>
<h2><a class="anchor" id="performance-optimization-2c"></a>
Timing individual variables</h2>
<p>In order to know which of your collective variables is taking more time to be computed, you should use the <a class="el" href="_d_e_b_u_g.html">DEBUG</a> DETAILED_TIMERS flag (place it after <a class="el" href="_m_o_l_i_n_f_o.html">MOLINFO</a>). The end of the <code>md.log</code> file should now look similar to this </p><pre class="fragment">PLUMED:                                                    1     1.138360     1.138360     1.138360     1.138360
PLUMED: 1 Prepare dependencies                           501     0.001654     0.000003     0.000003     0.000014
PLUMED: 2 Sharing data                                   501     0.052691     0.000105     0.000092     0.004898
PLUMED: 3 Waiting for data                               501     0.004488     0.000009     0.000008     0.000030
PLUMED: 4 Calculating (forward loop)                     501     0.444763     0.000888     0.000849     0.001809
PLUMED: 4A 1 @1                                          501     0.001294     0.000003     0.000002     0.000010
PLUMED: 4A 6 dp                                          501     0.007342     0.000015     0.000013     0.000045
PLUMED: 4A 7 cn                                          501     0.422879     0.000844     0.000807     0.001701
PLUMED: 4A 8 @8                                          501     0.001087     0.000002     0.000002     0.000014
PLUMED: 5 Applying (backward loop)                       501     0.112352     0.000224     0.000210     0.002120
PLUMED: 5A 0 @8                                          501     0.000713     0.000001     0.000001     0.000009
PLUMED: 5A 1 cn                                          501     0.069576     0.000139     0.000132     0.000324
PLUMED: 5A 2 dp                                          501     0.002932     0.000006     0.000005     0.000018
PLUMED: 5A 7 @1                                          501     0.000806     0.000002     0.000001     0.000010
PLUMED: 5B Update forces                                 501     0.029823     0.000060     0.000050     0.001948
PLUMED: 6 Update                                         501     0.009887     0.000020     0.000017     0.000110
</pre><p>Notice that running with DETAILED_TIMERS might slow down a bit more your simulation.</p>
<p>Each line tells you how expensive was the calculation of each collective variable. Find which is the most expensive! We will focus on it in the next points</p>
<h2><a class="anchor" id="performance-optimization-2d"></a>
Optimizing coordination numbers using neighbor lists</h2>
<p>The <a class="el" href="_c_o_o_r_d_i_n_a_t_i_o_n.html">COORDINATION</a> of multiple atoms can be very expensive for a number of reasons:</p><ul>
<li>It might require the calculation of a large number of distances</li>
<li>It might require many atoms to be copied from GROMACS to PLUMED</li>
</ul>
<p>In this specific example, the coordination number will require a number of calculations that is proportional to the number of water molecules in the system.</p>
<p>Repeat the timing above using neighbor lists. Here's how you should modify the line computing the COORDINATION in order to enable neighbor lists</p>

<div style="width: 90%; float:left" id="value_details_eg2"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.7-failed-red.svg" alt="tested on v2.7" /></div><pre style="width: 97%;" class="fragment">
<b name="eg2cn" onclick='showPath("eg2","eg2cn")'>cn: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_c_o_o_r_d_i_n_a_t_i_o_n.html" style="color:green">COORDINATION</a> <div class="tooltip">GROUPA<div class="right">First list of atoms. <i></i></div></div>=mg <div class="tooltip">GROUPB<div class="right">Second list of atoms (if empty, N*(N-1)/2 pairs in GROUPA are counted). <i></i></div></div>=ow <div class="tooltip">R_0<div class="right"><b> could not find this keyword </b><i></i></div></div>=0.261 <div class="tooltip">NLIST<div class="right">( default=off ) Use a neighbor list to speed up the calculation <i></i></div></div> <div class="tooltip">NL_STRIDE<div class="right">The frequency with which we are updating the atoms in the neighbor list <i></i></div></div>=20 <div class="tooltip">NL_CUTOFF<div class="right">The cutoff for the neighbor list <i></i></div></div>=1.0 <span style="display:none;" id="eg2cn"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
</pre>
<p>There are two critical parameters:</p><ul>
<li>the stride for the neighbor lists (here 20 steps).</li>
<li>the cutoff distance (here 1 nm).</li>
</ul>
<p>You should be <b>very careful</b> since using neighbor lists introduces approximations that might invalidate your calculation! The recommended procedure is to first perform a simulation where you compute your variable with different settings and compare the result. For instance:</p>

<div style="width: 90%; float:left" id="value_details_eg3"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.7-failed-red.svg" alt="tested on v2.7" /></div><pre style="width: 97%;" class="fragment">
<span style="color:blue">#SETTINGS MOLFILE=regtest/basic/rt32/helix.pdb</span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_m_o_l_i_n_f_o.html" style="color:green">MOLINFO</a> <div class="tooltip">STRUCTURE<div class="right"><b>compulsory keyword </b>
a file in pdb format containing a reference structure. <i></i></div></div>=conf.pdb <span style="display:none;" id="eg3"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg3wat" onclick='showPath("eg3","eg3wat")'>wat: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_g_r_o_u_p.html" style="color:green">GROUP</a> <div class="tooltip">ATOMS<div class="right">the numerical indexes for the set of atoms in the group. <i></i></div></div>=@water <span style="display:none;" id="eg3wat"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg3ow" onclick='showPath("eg3","eg3ow")'>ow: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_g_r_o_u_p.html" style="color:green">GROUP</a> <div class="tooltip">ATOMS<div class="right">the numerical indexes for the set of atoms in the group. <i></i></div></div>=@water <div class="tooltip">REMOVE<div class="right">remove these atoms from the list. <i></i></div></div>=@hydrogens <span style="display:none;" id="eg3ow"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg3mg" onclick='showPath("eg3","eg3mg")'>mg: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_g_r_o_u_p.html" style="color:green">GROUP</a> <div class="tooltip">ATOMS<div class="right">the numerical indexes for the set of atoms in the group. <i></i></div></div>=10484 <span style="display:none;" id="eg3mg"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg3p" onclick='showPath("eg3","eg3p")'>p: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_g_r_o_u_p.html" style="color:green">GROUP</a> <div class="tooltip">ATOMS<div class="right">the numerical indexes for the set of atoms in the group. <i></i></div></div>=@P-2 <span style="display:none;" id="eg3p"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg3dp" onclick='showPath("eg3","eg3dp")'>dp: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_d_i_s_t_a_n_c_e.html" style="color:green">DISTANCE</a> <div class="tooltip">ATOMS<div class="right">the pair of atom that we are calculating the distance between. <i></i></div></div>=<b name="eg3mg">mg</b>,<b name="eg3p">p</b> <span style="display:none;" id="eg3dp"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg3cn" onclick='showPath("eg3","eg3cn")'>cn: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_c_o_o_r_d_i_n_a_t_i_o_n.html" style="color:green">COORDINATION</a> <div class="tooltip">GROUPA<div class="right">First list of atoms. <i></i></div></div>=<b name="eg3mg">mg</b> <div class="tooltip">GROUPB<div class="right">Second list of atoms (if empty, N*(N-1)/2 pairs in GROUPA are counted). <i></i></div></div>=<b name="eg3ow">ow</b> <div class="tooltip">R_0<div class="right"><b> could not find this keyword </b><i></i></div></div>=0.261 <span style="display:none;" id="eg3cn"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># use increasing values of the stride</span>
<b name="eg3cn2" onclick='showPath("eg3","eg3cn2")'>cn2: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_c_o_o_r_d_i_n_a_t_i_o_n.html" style="color:green">COORDINATION</a> <div class="tooltip">GROUPA<div class="right">First list of atoms. <i></i></div></div>=<b name="eg3mg">mg</b> <div class="tooltip">GROUPB<div class="right">Second list of atoms (if empty, N*(N-1)/2 pairs in GROUPA are counted). <i></i></div></div>=<b name="eg3ow">ow</b> <div class="tooltip">R_0<div class="right"><b> could not find this keyword </b><i></i></div></div>=0.261 <div class="tooltip">NLIST<div class="right">( default=off ) Use a neighbor list to speed up the calculation <i></i></div></div> <div class="tooltip">NL_STRIDE<div class="right">The frequency with which we are updating the atoms in the neighbor list <i></i></div></div>=2 <div class="tooltip">NL_CUTOFF<div class="right">The cutoff for the neighbor list <i></i></div></div>=1.0 <span style="display:none;" id="eg3cn2"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg3cn10" onclick='showPath("eg3","eg3cn10")'>cn10: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_c_o_o_r_d_i_n_a_t_i_o_n.html" style="color:green">COORDINATION</a> <div class="tooltip">GROUPA<div class="right">First list of atoms. <i></i></div></div>=<b name="eg3mg">mg</b> <div class="tooltip">GROUPB<div class="right">Second list of atoms (if empty, N*(N-1)/2 pairs in GROUPA are counted). <i></i></div></div>=<b name="eg3ow">ow</b> <div class="tooltip">R_0<div class="right"><b> could not find this keyword </b><i></i></div></div>=0.261 <div class="tooltip">NLIST<div class="right">( default=off ) Use a neighbor list to speed up the calculation <i></i></div></div> <div class="tooltip">NL_STRIDE<div class="right">The frequency with which we are updating the atoms in the neighbor list <i></i></div></div>=10 <div class="tooltip">NL_CUTOFF<div class="right">The cutoff for the neighbor list <i></i></div></div>=1.0 <span style="display:none;" id="eg3cn10"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg3cn20" onclick='showPath("eg3","eg3cn20")'>cn20: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_c_o_o_r_d_i_n_a_t_i_o_n.html" style="color:green">COORDINATION</a> <div class="tooltip">GROUPA<div class="right">First list of atoms. <i></i></div></div>=<b name="eg3mg">mg</b> <div class="tooltip">GROUPB<div class="right">Second list of atoms (if empty, N*(N-1)/2 pairs in GROUPA are counted). <i></i></div></div>=<b name="eg3ow">ow</b> <div class="tooltip">R_0<div class="right"><b> could not find this keyword </b><i></i></div></div>=0.261 <div class="tooltip">NLIST<div class="right">( default=off ) Use a neighbor list to speed up the calculation <i></i></div></div> <div class="tooltip">NL_STRIDE<div class="right">The frequency with which we are updating the atoms in the neighbor list <i></i></div></div>=20 <div class="tooltip">NL_CUTOFF<div class="right">The cutoff for the neighbor list <i></i></div></div>=1.0 <span style="display:none;" id="eg3cn20"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg3cn50" onclick='showPath("eg3","eg3cn50")'>cn50: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_c_o_o_r_d_i_n_a_t_i_o_n.html" style="color:green">COORDINATION</a> <div class="tooltip">GROUPA<div class="right">First list of atoms. <i></i></div></div>=<b name="eg3mg">mg</b> <div class="tooltip">GROUPB<div class="right">Second list of atoms (if empty, N*(N-1)/2 pairs in GROUPA are counted). <i></i></div></div>=<b name="eg3ow">ow</b> <div class="tooltip">R_0<div class="right"><b> could not find this keyword </b><i></i></div></div>=0.261 <div class="tooltip">NLIST<div class="right">( default=off ) Use a neighbor list to speed up the calculation <i></i></div></div> <div class="tooltip">NL_STRIDE<div class="right">The frequency with which we are updating the atoms in the neighbor list <i></i></div></div>=50 <div class="tooltip">NL_CUTOFF<div class="right">The cutoff for the neighbor list <i></i></div></div>=1.0 <span style="display:none;" id="eg3cn50"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># notice that here we are using a regular expression to select all coordination numbers</span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_p_r_i_n_t.html" style="color:green">PRINT</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<b name="eg3dp">dp</b>,(cn.*) <div class="tooltip">FILE<div class="right">the name of the file on which to output these quantities <i></i></div></div>=COLVAR <div class="tooltip">STRIDE<div class="right"><b>compulsory keyword ( default=1 )</b>
the frequency with which the quantities of interest should be output <i></i></div></div>=1 <span style="display:none;" id="eg3"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
</pre>
<p>In the <code>COLVAR</code> files you will see multiple columns corresponding to values computed using different strides. You should pick a column such that the reported value is not too different from the one in the third column (that is: without neighbor lists). "Not too different" of course depends on how much you want to trade in accuracy vs speed.</p>
<dl class="section warning"><dt>Warning</dt><dd>As of PLUMED 2.5, the construction of the neighbor list is not parallelized! As a consequence, the advantage of using it might be not compensated by the slow time required to construct it. This might change in a future PLUMED version. In addition, notice that the time for constructing the list is not present in the breakdown of the timers seen above, but is part of the "Prepare dependencies" stage.</dd></dl>
<p>Once you picked a setting that gives you results that are accurate enough, you can measure the speed using that setting alone using an input where only that specific setting is used. You will probably see that using neighbor lists is usually inconvenient unless you run with a single or very few cores.</p>
<h2><a class="anchor" id="performance-optimization-2e"></a>
Biasing your CVs: multiple time stepping</h2>
<p>So far we have used PLUMED to analyze a CV on the fly. In principle, when you analyze CVs you typically only print them with a given stride (say, every 100 steps). This of course moderates significantly their cost. However, when you bias a CV you typically need to compute it at every step. Let's say that you want to use a restraint to make sure that the Mg ion is always six coordinated with water. This can be obtained using a <a class="el" href="_r_e_s_t_r_a_i_n_t.html">RESTRAINT</a> located AT=6. Remove the <a class="el" href="_p_r_i_n_t.html">PRINT</a> action from your input file and replace it with the following actions: </p>
<div style="width: 90%; float:left" id="value_details_eg4"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.7-failed-red.svg" alt="tested on v2.7" /></div><pre style="width: 97%;" class="fragment">
<span style="color:blue"># apply a restraint. this will be computed at every step by default</span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_r_e_s_t_r_a_i_n_t.html" style="color:green">RESTRAINT</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=cn <div class="tooltip">AT<div class="right"><b>compulsory keyword </b>
the position of the restraint <i></i></div></div>=6 <div class="tooltip">KAPPA<div class="right"><b>compulsory keyword ( default=0.0 )</b>
specifies that the restraint is harmonic and what the values of the force constants
on each of the variables are <i></i></div></div>=5.0 <span style="display:none;" id="eg4"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># only print every 100 steps</span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_p_r_i_n_t.html" style="color:green">PRINT</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=dp,cn <div class="tooltip">FILE<div class="right">the name of the file on which to output these quantities <i></i></div></div>=COLVAR <div class="tooltip">STRIDE<div class="right"><b>compulsory keyword ( default=1 )</b>
the frequency with which the quantities of interest should be output <i></i></div></div>=100 <span style="display:none;" id="eg4"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
</pre>
<p>Now measure the speed of your simulation. You should see some overhead due to PLUMED. You can now try to use multiple-time-stepping <a class="el" href="citelist.html#CITEREF_Ferrarotti2015">[46]</a>. To do so add a <code>STRIDE</code> option to the <a class="el" href="_r_e_s_t_r_a_i_n_t.html">RESTRAINT</a> line. You can also use the <a class="el" href="_e_f_f_e_c_t_i_v_e__e_n_e_r_g_y__d_r_i_f_t.html">EFFECTIVE_ENERGY_DRIFT</a> action to print a kind of "total energy drift" due to the application of the PLUMED bias. In molecular dynamics simulation you usually monitor the drift in the total energy in order to choose the time step. Here you can use the value of the effective energy drift to choose the stride for multiple-time-stepping. </p>
<div style="width: 90%; float:left" id="value_details_eg5"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.7-failed-red.svg" alt="tested on v2.7" /></div><pre style="width: 97%;" class="fragment">
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_r_e_s_t_r_a_i_n_t.html" style="color:green">RESTRAINT</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=cn <div class="tooltip">AT<div class="right"><b>compulsory keyword </b>
the position of the restraint <i></i></div></div>=6 <div class="tooltip">KAPPA<div class="right"><b>compulsory keyword ( default=0.0 )</b>
specifies that the restraint is harmonic and what the values of the force constants
on each of the variables are <i></i></div></div>=5.0 <div class="tooltip">STRIDE<div class="right">the frequency with which the forces due to the bias should be calculated. <i></i></div></div>=2 <span style="display:none;" id="eg5"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_e_f_f_e_c_t_i_v_e__e_n_e_r_g_y__d_r_i_f_t.html" style="color:green">EFFECTIVE_ENERGY_DRIFT</a> <div class="tooltip">PRINT_STRIDE<div class="right"><b>compulsory keyword </b>
frequency to which output the effective energy drift on FILE <i></i></div></div>=100 <div class="tooltip">FILE<div class="right"><b>compulsory keyword </b>
file on which to output the effective energy drift. <i></i></div></div>=eff <span style="display:none;" id="eg5"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
</pre>
<p>Using a <code>STRIDE=5</code> you should get something like this </p><pre class="fragment">#! FIELDS time effective-energy
 0.000000 0.000000
 0.200000 0.012010
 0.400000 0.024574
 0.600000 0.105866
 0.800000 0.178739
 1.000000 0.254018
</pre><p> The effective energy will drift quickly! Using a <code>STRIDE=2</code> instead the effective energy will be very stable </p><pre class="fragment">#! FIELDS time effective-energy
 0.000000 0.000000
 0.200000 0.000980
 0.400000 0.000041
 0.600000 -0.000162
 0.800000 0.000078
 1.000000 -0.000395
</pre><dl class="section note"><dt>Note</dt><dd>The <code>STRIDE</code> option is not included in the manual, but can be used for all the bias actions to activate multiple-time-stepping.</dd></dl>
<h2><a class="anchor" id="performance-optimization-2f"></a>
Using grids in metadynamics</h2>
<p>Let's try to perform a metadynamics simulation biasing the coordination number and the distance between the magnesium ion and the phosphate. Parameters are similar to those used in <a class="el" href="citelist.html#CITEREF_cunha2017unraveling">[40]</a>, although we use here a shorter deposition pace in order to artificially increase the computational cost.</p>

<div style="width: 90%; float:left" id="value_details_eg6"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.7-failed-red.svg" alt="tested on v2.7" /></div><pre style="width: 97%;" class="fragment">
<span style="color:blue">#SETTINGS MOLFILE=regtest/basic/rt32/helix.pdb</span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_m_o_l_i_n_f_o.html" style="color:green">MOLINFO</a> <div class="tooltip">STRUCTURE<div class="right"><b>compulsory keyword </b>
a file in pdb format containing a reference structure. <i></i></div></div>=conf.pdb <span style="display:none;" id="eg6"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg6wat" onclick='showPath("eg6","eg6wat")'>wat: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_g_r_o_u_p.html" style="color:green">GROUP</a> <div class="tooltip">ATOMS<div class="right">the numerical indexes for the set of atoms in the group. <i></i></div></div>=@water <span style="display:none;" id="eg6wat"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg6ow" onclick='showPath("eg6","eg6ow")'>ow: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_g_r_o_u_p.html" style="color:green">GROUP</a> <div class="tooltip">ATOMS<div class="right">the numerical indexes for the set of atoms in the group. <i></i></div></div>=@water <div class="tooltip">REMOVE<div class="right">remove these atoms from the list. <i></i></div></div>=@hydrogens <span style="display:none;" id="eg6ow"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg6mg" onclick='showPath("eg6","eg6mg")'>mg: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_g_r_o_u_p.html" style="color:green">GROUP</a> <div class="tooltip">ATOMS<div class="right">the numerical indexes for the set of atoms in the group. <i></i></div></div>=10484 <span style="display:none;" id="eg6mg"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg6p" onclick='showPath("eg6","eg6p")'>p: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_g_r_o_u_p.html" style="color:green">GROUP</a> <div class="tooltip">ATOMS<div class="right">the numerical indexes for the set of atoms in the group. <i></i></div></div>=@P-2 <span style="display:none;" id="eg6p"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg6dp" onclick='showPath("eg6","eg6dp")'>dp: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_d_i_s_t_a_n_c_e.html" style="color:green">DISTANCE</a> <div class="tooltip">ATOMS<div class="right">the pair of atom that we are calculating the distance between. <i></i></div></div>=<b name="eg6mg">mg</b>,<b name="eg6p">p</b> <span style="display:none;" id="eg6dp"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg6cn" onclick='showPath("eg6","eg6cn")'>cn: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_c_o_o_r_d_i_n_a_t_i_o_n.html" style="color:green">COORDINATION</a> <div class="tooltip">GROUPA<div class="right">First list of atoms. <i></i></div></div>=<b name="eg6mg">mg</b> <div class="tooltip">GROUPB<div class="right">Second list of atoms (if empty, N*(N-1)/2 pairs in GROUPA are counted). <i></i></div></div>=<b name="eg6ow">ow</b> <div class="tooltip">R_0<div class="right"><b> could not find this keyword </b><i></i></div></div>=0.261 <span style="display:none;" id="eg6cn"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg6metadP" onclick='showPath("eg6","eg6metadP")'>metadP: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_m_e_t_a_d.html" style="color:green">METAD</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<b name="eg6dp">dp</b>,<b name="eg6cn">cn</b> <div class="tooltip">SIGMA<div class="right"><b>compulsory keyword </b>
the widths of the Gaussian hills <i></i></div></div>=0.05,0.1 <div class="tooltip">HEIGHT<div class="right">the heights of the Gaussian hills. <i></i></div></div>=0.3 <div class="tooltip">PACE<div class="right"><b>compulsory keyword </b>
the frequency for hill addition <i></i></div></div>=100 <div class="tooltip">TEMP<div class="right">the system temperature - this is only needed if you are doing well-tempered metadynamics
<i></i></div></div>=300 <div class="tooltip">BIASFACTOR<div class="right">use well tempered metadynamics and use this bias factor. <i></i></div></div>=15 <span style="display:none;" id="eg6metadP"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_p_r_i_n_t.html" style="color:green">PRINT</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<b name="eg6dp">dp</b>,<b name="eg6cn">cn</b> <div class="tooltip">FILE<div class="right">the name of the file on which to output these quantities <i></i></div></div>=COLVAR <div class="tooltip">STRIDE<div class="right"><b>compulsory keyword ( default=1 )</b>
the frequency with which the quantities of interest should be output <i></i></div></div>=100 <span style="display:none;" id="eg6"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
</pre>
<p>If you use this input for a very long simulation you will realize that most of the time is spent within the <code>METAD</code> action. The reason is simple: in its standard implementation, metadynamics is implemented as a history dependent potential where, every time we need to compute the force, a sum over the past history is performed. The history is saved in the <code>HILLS</code> file (have a look at it). When this file becomes too large the simulation will slow down. Without the need to run a very long simulation, we can see the problem by artificially creating a very long HILLS file. Every line of the HILLS file contains:</p><ul>
<li>The value of time.</li>
<li>The coordinates at which the Gaussian function was deposited.</li>
<li>The width of the deposited Gaussian function</li>
<li>The height</li>
<li>A number called bias-factor (check <a class="el" href="_m_e_t_a_d.html">METAD</a> manual to know what it means).</li>
</ul>
<p>We can make an artificially long HILLS file and then use it to restart our simulation. </p><pre class="fragment">var="$(&lt;HILLS)
for((i=0;i&lt;=10000;i++)) ; do echo "$var" ; done | awk '{if($1!="#!") print $1,$2,$3,$4,$5,$6/100000,$7; else print}' &gt; HILLS_long
</pre><p>Now modify your <code>plumed.dat</code> file so that it will read the <code>HILLS_long</code> file: </p>
<div style="width: 90%; float:left" id="value_details_eg7"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.7-failed-red.svg" alt="tested on v2.7" /></div><pre style="width: 97%;" class="fragment">
<span style="color:blue">#SETTINGS MOLFILE=regtest/basic/rt32/helix.pdb</span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_m_o_l_i_n_f_o.html" style="color:green">MOLINFO</a> <div class="tooltip">STRUCTURE<div class="right"><b>compulsory keyword </b>
a file in pdb format containing a reference structure. <i></i></div></div>=conf.pdb <span style="display:none;" id="eg7"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg7wat" onclick='showPath("eg7","eg7wat")'>wat: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_g_r_o_u_p.html" style="color:green">GROUP</a> <div class="tooltip">ATOMS<div class="right">the numerical indexes for the set of atoms in the group. <i></i></div></div>=@water <span style="display:none;" id="eg7wat"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg7ow" onclick='showPath("eg7","eg7ow")'>ow: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_g_r_o_u_p.html" style="color:green">GROUP</a> <div class="tooltip">ATOMS<div class="right">the numerical indexes for the set of atoms in the group. <i></i></div></div>=@water <div class="tooltip">REMOVE<div class="right">remove these atoms from the list. <i></i></div></div>=@hydrogens <span style="display:none;" id="eg7ow"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg7mg" onclick='showPath("eg7","eg7mg")'>mg: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_g_r_o_u_p.html" style="color:green">GROUP</a> <div class="tooltip">ATOMS<div class="right">the numerical indexes for the set of atoms in the group. <i></i></div></div>=10484 <span style="display:none;" id="eg7mg"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg7p" onclick='showPath("eg7","eg7p")'>p: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_g_r_o_u_p.html" style="color:green">GROUP</a> <div class="tooltip">ATOMS<div class="right">the numerical indexes for the set of atoms in the group. <i></i></div></div>=@P-2 <span style="display:none;" id="eg7p"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg7dp" onclick='showPath("eg7","eg7dp")'>dp: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_d_i_s_t_a_n_c_e.html" style="color:green">DISTANCE</a> <div class="tooltip">ATOMS<div class="right">the pair of atom that we are calculating the distance between. <i></i></div></div>=<b name="eg7mg">mg</b>,<b name="eg7p">p</b> <span style="display:none;" id="eg7dp"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg7cn" onclick='showPath("eg7","eg7cn")'>cn: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_c_o_o_r_d_i_n_a_t_i_o_n.html" style="color:green">COORDINATION</a> <div class="tooltip">GROUPA<div class="right">First list of atoms. <i></i></div></div>=<b name="eg7mg">mg</b> <div class="tooltip">GROUPB<div class="right">Second list of atoms (if empty, N*(N-1)/2 pairs in GROUPA are counted). <i></i></div></div>=<b name="eg7ow">ow</b> <div class="tooltip">R_0<div class="right"><b> could not find this keyword </b><i></i></div></div>=0.261 <span style="display:none;" id="eg7cn"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg7metadP" onclick='showPath("eg7","eg7metadP")'>metadP: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_m_e_t_a_d.html" style="color:green">METAD</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<b name="eg7dp">dp</b>,<b name="eg7cn">cn</b> <div class="tooltip">SIGMA<div class="right"><b>compulsory keyword </b>
the widths of the Gaussian hills <i></i></div></div>=0.05,0.1 <div class="tooltip">HEIGHT<div class="right">the heights of the Gaussian hills. <i></i></div></div>=0.3 <div class="tooltip">PACE<div class="right"><b>compulsory keyword </b>
the frequency for hill addition <i></i></div></div>=100 <div class="tooltip">TEMP<div class="right">the system temperature - this is only needed if you are doing well-tempered metadynamics
<i></i></div></div>=300 <div class="tooltip">BIASFACTOR<div class="right">use well tempered metadynamics and use this bias factor. <i></i></div></div>=15 <div class="tooltip">FILE<div class="right"><b>compulsory keyword ( default=HILLS )</b>
a file in which the list of added hills is stored <i></i></div></div>=HILLS_long <div class="tooltip">RESTART<div class="right">allows per-action setting of restart (YES/NO/AUTO) <i></i></div></div>=YES <span style="display:none;" id="eg7metadP"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_p_r_i_n_t.html" style="color:green">PRINT</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<b name="eg7dp">dp</b>,<b name="eg7cn">cn</b> <div class="tooltip">FILE<div class="right">the name of the file on which to output these quantities <i></i></div></div>=COLVAR <div class="tooltip">STRIDE<div class="right"><b>compulsory keyword ( default=1 )</b>
the frequency with which the quantities of interest should be output <i></i></div></div>=100 <span style="display:none;" id="eg7"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
</pre>
<p>Run your simulation and check the timing. Which is the most expensive action now?</p>
<p>The standard solution to the problem above is to use a grid to store the Gaussian functions. In this manner, at the first step PLUMED will take some time to put all the Gaussian functions on the grid, but subsequent calculations of the force will be much faster, since they will just require that the action look up the value on the grid (rather than a sum over the history).</p>
<p>Time the simulation using the following lines to perform METAD: </p>
<div style="width: 90%; float:left" id="value_details_eg8"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.7-failed-red.svg" alt="tested on v2.7" /></div><pre style="width: 97%;" class="fragment">
<b name="eg8metadP" onclick='showPath("eg8","eg8metadP")'>metadP: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_m_e_t_a_d.html" style="color:green">METAD</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=dp,cn <div class="tooltip">SIGMA<div class="right"><b>compulsory keyword </b>
the widths of the Gaussian hills <i></i></div></div>=0.05,0.1 <div class="tooltip">HEIGHT<div class="right">the heights of the Gaussian hills. <i></i></div></div>=0.3 <div class="tooltip">PACE<div class="right"><b>compulsory keyword </b>
the frequency for hill addition <i></i></div></div>=100 <div class="tooltip">TEMP<div class="right">the system temperature - this is only needed if you are doing well-tempered metadynamics
<i></i></div></div>=300 <div class="tooltip">BIASFACTOR<div class="right">use well tempered metadynamics and use this bias factor. <i></i></div></div>=15 <div class="tooltip">FILE<div class="right"><b>compulsory keyword ( default=HILLS )</b>
a file in which the list of added hills is stored <i></i></div></div>=HILLS_long <div class="tooltip">RESTART<div class="right">allows per-action setting of restart (YES/NO/AUTO) <i></i></div></div>=YES <div class="tooltip">GRID_MIN<div class="right">the lower bounds for the grid <i></i></div></div>=3,4 <div class="tooltip">GRID_MAX<div class="right">the upper bounds for the grid <i></i></div></div>=4,6 <span style="display:none;" id="eg8metadP"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
</pre>
<p>Which is the most expensive action now?</p>
<dl class="section warning"><dt>Warning</dt><dd>If a simulation reaches a point outside of the grid PLUMED will stop! You should be generous in the boundaries, but not too much or your simulation might require too much memory and crash</dd></dl>
<h2><a class="anchor" id="performance-optimization-2g"></a>
Running GROMACS on the GPU</h2>
<p>All the exercises so far were done running GROMACS on the CPU. You should have noticed that the wall-clock time of a simulation run using PLUMED is approximately equal to the sum of:</p><ul>
<li>the wall-clock time of an equivalent simulation <b>not</b> using PLUMED, plus</li>
<li>the total time required by PLUMED, shown at the end of the <code>md.log</code> file.</li>
</ul>
<p>Let's see what happens using the GPU. In this case the first couple of thousands steps are kind of different since GROMACS tries to optimize the GPU load, so we should run a longer simulation to estimate the simulation speed. For simplicity, use the following <code>plumed.dat</code> file: </p>
<div style="width: 90%; float:left" id="value_details_eg9"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.7-failed-red.svg" alt="tested on v2.7" /></div><pre style="width: 97%;" class="fragment">
<span style="color:blue">#SETTINGS MOLFILE=regtest/basic/rt32/helix.pdb</span>
<span style="color:blue"># vim:ft=plumed</span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_m_o_l_i_n_f_o.html" style="color:green">MOLINFO</a> <div class="tooltip">STRUCTURE<div class="right"><b>compulsory keyword </b>
a file in pdb format containing a reference structure. <i></i></div></div>=conf.pdb <span style="display:none;" id="eg9"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_d_e_b_u_g.html" style="color:green">DEBUG</a> <div class="tooltip">DETAILED_TIMERS<div class="right">( default=off ) switch on detailed timers <i></i></div></div> <span style="display:none;" id="eg9"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg9wat" onclick='showPath("eg9","eg9wat")'>wat: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_g_r_o_u_p.html" style="color:green">GROUP</a> <div class="tooltip">ATOMS<div class="right">the numerical indexes for the set of atoms in the group. <i></i></div></div>=@water <span style="display:none;" id="eg9wat"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg9ow" onclick='showPath("eg9","eg9ow")'>ow: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_g_r_o_u_p.html" style="color:green">GROUP</a> <div class="tooltip">ATOMS<div class="right">the numerical indexes for the set of atoms in the group. <i></i></div></div>=@water <div class="tooltip">REMOVE<div class="right">remove these atoms from the list. <i></i></div></div>=@hydrogens <span style="display:none;" id="eg9ow"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg9mg" onclick='showPath("eg9","eg9mg")'>mg: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_g_r_o_u_p.html" style="color:green">GROUP</a> <div class="tooltip">ATOMS<div class="right">the numerical indexes for the set of atoms in the group. <i></i></div></div>=27275 <span style="display:none;" id="eg9mg"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg9p" onclick='showPath("eg9","eg9p")'>p: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_g_r_o_u_p.html" style="color:green">GROUP</a> <div class="tooltip">ATOMS<div class="right">the numerical indexes for the set of atoms in the group. <i></i></div></div>=@P-2 <span style="display:none;" id="eg9p"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg9dp" onclick='showPath("eg9","eg9dp")'>dp: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_d_i_s_t_a_n_c_e.html" style="color:green">DISTANCE</a> <div class="tooltip">ATOMS<div class="right">the pair of atom that we are calculating the distance between. <i></i></div></div>=<b name="eg9mg">mg</b>,<b name="eg9p">p</b> <span style="display:none;" id="eg9dp"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg9cn" onclick='showPath("eg9","eg9cn")'>cn: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_c_o_o_r_d_i_n_a_t_i_o_n.html" style="color:green">COORDINATION</a> <div class="tooltip">GROUPA<div class="right">First list of atoms. <i></i></div></div>=<b name="eg9mg">mg</b> <div class="tooltip">GROUPB<div class="right">Second list of atoms (if empty, N*(N-1)/2 pairs in GROUPA are counted). <i></i></div></div>=<b name="eg9ow">ow</b> <div class="tooltip">R_0<div class="right"><b> could not find this keyword </b><i></i></div></div>=0.261 <span style="display:none;" id="eg9cn"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_p_r_i_n_t.html" style="color:green">PRINT</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<b name="eg9dp">dp</b>,(cn.*) <div class="tooltip">FILE<div class="right">the name of the file on which to output these quantities <i></i></div></div>=COLVAR <div class="tooltip">STRIDE<div class="right"><b>compulsory keyword ( default=1 )</b>
the frequency with which the quantities of interest should be output <i></i></div></div>=100 <span style="display:none;" id="eg9"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_r_e_s_t_r_a_i_n_t.html" style="color:green">RESTRAINT</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<b name="eg9cn">cn</b> <div class="tooltip">AT<div class="right"><b>compulsory keyword </b>
the position of the restraint <i></i></div></div>=5 <div class="tooltip">KAPPA<div class="right"><b>compulsory keyword ( default=0.0 )</b>
specifies that the restraint is harmonic and what the values of the force constants
on each of the variables are <i></i></div></div>=5.0 <span style="display:none;" id="eg9"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
</pre>
<p> Let's compare the timings with/without GPU and with/without PLUMED using the following commands </p><pre class="fragment">gmx_mpi mdrun -nsteps 10000 -v -ntomp 12 -pin on -nb cpu
gmx_mpi mdrun -nsteps 10000 -v -ntomp 12 -pin on -plumed plumed.dat -nb cpu
gmx_mpi mdrun -nsteps 10000 -v -ntomp 12 -pin on 
gmx_mpi mdrun -nsteps 10000 -v -ntomp 12 -pin on -plumed plumed.dat 
</pre><p> When we run with PLUMED, let's also take note of the total time spent in PLUMED, written in the <code>md.log</code> file. Here's the result on my workstation:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">GPU </th><th class="markdownTableHeadCenter">PLUMED </th><th class="markdownTableHeadCenter">Wall t (s) </th><th class="markdownTableHeadCenter">PLUMED time (s)  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">no </td><td class="markdownTableBodyCenter">no </td><td class="markdownTableBodyCenter">49.931 </td><td class="markdownTableBodyCenter">/  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">no </td><td class="markdownTableBodyCenter">yes </td><td class="markdownTableBodyCenter">65.469 </td><td class="markdownTableBodyCenter">13.44  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">yes </td><td class="markdownTableBodyCenter">no </td><td class="markdownTableBodyCenter">19.648 </td><td class="markdownTableBodyCenter">/  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">yes </td><td class="markdownTableBodyCenter">yes </td><td class="markdownTableBodyCenter">21.745 </td><td class="markdownTableBodyCenter">12.36  </td></tr>
</table>
<p>PLUMED is not running on the GPU, so the total time spent in PLUMED is roughly the same both with and without GPU (12-13 seconds). However, when GROMACS runs using the GPU the load balancing transfers part of the load to the GPU. As a consequence, the total wall time is incremented by approximately 1 sec. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.3.1-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
<!--    <li class="navelem"><a class="el" href="tutorials.html">Tutorials</a></li>  -->
    <li class="footer">   <!--- Generated by -->
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
