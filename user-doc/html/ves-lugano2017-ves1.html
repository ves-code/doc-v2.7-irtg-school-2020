<!-- HTML header for doxygen 1.8.3.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta name="robots" content="noindex">
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<title>PLUMED: MARVEL-VES tutorial (Lugano Feb 2017): VES 1</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<script>
   var redpath = "";
   
   function showPath(eg,name) {
     var i; var y = document.getElementsByName(redpath);
     for (i=0; i < y.length; i++ ) { y[i].style.color="black"; }
     var x = document.getElementsByName(name); redpath=name;
     for (i = 0; i < x.length; i++) { x[i].style.color="red"; }
     var valid="value_details_".concat(eg);
     var valueField = document.getElementById(valid);
     var dataField = document.getElementById(name);
     valueField.innerHTML = dataField.innerHTML;
   }
   function swapInput(name) {
     var btn = document.getElementById(name + "_button");
     var mydiv = document.getElementById("input_" + name);
     if( btn.textContent=="expand shortcuts" ) {
         btn.textContent = "contract shortcuts";
         var dataField = document.getElementById(name + "long");
         mydiv.innerHTML = dataField.innerHTML;
     } else if( btn.textContent=="contract shortcuts" ) {
         btn.textContent = "expand shortcuts";
         var dataField = document.getElementById(name + "short");
         mydiv.innerHTML = dataField.innerHTML;
     }
   }
</script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table align="center" frame="void" width="98%" cellpadding="2%">
<tbody>
<tr style="height: 30px;">
<td valign="center"> &nbsp; <img src="pigeon.png" width="120"/></td>
<td style="padding-left: 0.2em;" width="74%"> <a href="http://www.plumed.org"> <img src="logo.png" width="400" /> </td>
<td style="padding-left: 0.2em;" align="right"> <a href="../../developer-doc/html/index.html"> <img src="user-logo.png" width="180" /> </a> </td>
</tr>
</tbody>
</table>
<!--
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">PLUMED
   &#160;<span id="projectnumber">2.7b</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
-->
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('ves-lugano2017-ves1.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">MARVEL-VES tutorial (Lugano Feb 2017): VES 1 </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="ves-lugano2017-ves1-lo"></a>
Learning Outcomes</h1>
<p>Once this tutorial is completed students will learn to:</p>
<ul>
<li>Use different target distributions and choose the most appropriate for their problem.</li>
<li>Use different basis sets and order of the expansions. Select the appropriate order for their problem.</li>
<li>Use the optimization algorithm and choose the parameters.</li>
<li>Construct biases in 1 dimension.</li>
<li>Assess the convergence of the simulation.</li>
<li>Obtain biased and unbiased histograms.</li>
</ul>
<h1><a class="anchor" id="ves-lugano2017-ves1-resources"></a>
Resources</h1>
<p>The <a href="tutorial-resources/ves-lugano2017-ves1.tar.gz" download="ves-lugano2017-ves1.tar.gz">tarball </a> for this project contains the following folders:</p>
<ul>
<li>Example1 : Contains the input file for the first example.</li>
<li>Example2 : Contains the input file for the second example.</li>
</ul>
<h1><a class="anchor" id="ves-lugano2017-ves1-summary"></a>
Summary of theory</h1>
<p>Variationally enhanced sampling <a class="el" href="citelist.html#CITEREF_Valsson-PRL-2014">[117]</a> is based on the the following functional of the bias potential: </p><p class="formulaDsp">
\[ \Omega [V] = \frac{1}{\beta} \log \frac {\int d\mathbf{s} \, e^{-\beta \left[ F(\mathbf{s}) + V(\mathbf{s})\right]}} {\int d\mathbf{s} \, e^{-\beta F(\mathbf{s})}} + \int d\mathbf{s} \, p(\mathbf{s}) V(\mathbf{s}), \]
</p>
<p> where \(\mathbf{s}\) are the CVs to be biased, \( p(\mathbf{s}) \) is a predefined probability distribution that we will refer to as the target distribution, and \( F(\mathbf{s}) \) is the free energy surface. This functional can be shown to be convex and to have a minimum at: </p><p class="formulaDsp">
\[ V(\mathbf{s}) = -F(\mathbf{s})-{\frac {1}{\beta}} \log {p(\mathbf{s})}. \]
</p>
<p> The last equation states that once that the functional \( \Omega [V] \) is minimized, the bias and the target distribution allow calculating the free energy. The target distribution \( p(\mathbf{s}) \) can be chosen at will and it is the distribution of the CVs once that \( \Omega [V] \) has been minimized.</p>
<p>The variational principle is put to practice by expanding \( V(\mathbf{s}) \) in some basis set: </p><p class="formulaDsp">
\[ V(\mathbf{s}) = \sum\limits_{i} \alpha_i \, f_i(\mathbf{s}), \]
</p>
<p> where \( f_i(\mathbf{s}) \) are the basis functions and the \(\boldsymbol\alpha \) are the coefficients in the expansion. We then need to find the \(\boldsymbol\alpha \) that minimize \( \Omega [V] \). In principle one could use any optimization algorithm. In practice the algorithm that has become the default choice for VES is the so-called averaged stochastic gradient descent algorithm <a class="el" href="citelist.html#CITEREF_Bach-NIPS-2013">[6]</a>. In this algorithm the \(\boldsymbol\alpha \) are evolved iteratively according to: </p><p class="formulaDsp">
\[ \boldsymbol\alpha^{(n+1)} = \boldsymbol\alpha^{(n)}-\mu \left[ \nabla\Omega(\bar{\boldsymbol\alpha}^{(n)})+ H(\bar{\boldsymbol\alpha}^{(n)})[\boldsymbol\alpha^{(n)}-\bar{\boldsymbol\alpha}^{(n)}] \right] \]
</p>
<p> where \(\mu\) is the step size, \(\bar{\boldsymbol\alpha}^{(n)} \) is the running average of \(\boldsymbol\alpha^{(n)} \) at iteration \( n \), and \(\nabla\Omega(\bar{\boldsymbol\alpha}^{(n)}) \) and \(H(\bar{\boldsymbol\alpha}^{(n)}) \) are the gradient and Hessian of \( \Omega[V] \) evaluated at the running average at iteration \( n \), respectively. The behavior of the coefficients will become clear in the examples below.</p>
<h1><a class="anchor" id="ves-lugano2017-ves1-instructions"></a>
Instructions</h1>
<h2><a class="anchor" id="ves-lugano2017-ves1-subsection-1"></a>
The system</h2>
<p>We will consider the same system employed for the metadynamics tutorial.</p>
<h2><a class="anchor" id="ves-lugano2017-ves1-subsection-2"></a>
Example 1: First VES simulation</h2>
<p>For the first VES simulation we will revisit the problem of the ion pair dissociation but replacing the metadynamics bias with a VES bias. The bias potential will be constructed on the distance Na-Cl as done before. We will still use the upper wall used in the metadynamics tutorial to make the actual example as similar as possible to the previous one. We will then see that VES has a more natural way to deal with barriers. All files needed for this example can be found in the Example1 folder.</p>
<p>Every VES simulation has three key ingredients:</p>
<ul>
<li>Basis set</li>
<li>Target distribution</li>
<li>Optimization algorithm</li>
</ul>
<p>For the basis set we will choose Legendre polynomials defined in the interval [0.23,0.7] nm. Legendre polynomials are a good choice for non-periodic CVs. A rule of thumb for choosing the order of the expansion is that an expansion of order N can capture features of the FES of approximately L/N where L is the length of the interval. In this case, an order of 10 is able to capture features of the order of around 0.05 nm. We will see afterwards that the order of the expansion is not critical as long as we obtain good sampling at convergence. If this is the case, it is possible to obtain finer features of the FES through reweighting. The syntax for this basis set in Plumed is: </p>
<div style="width: 90%; float:left" id="value_details_eg1"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.7-incomplete-yellow.svg" alt="tested on v2.7" /></div><pre style="width: 97%;" class="fragment">
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/___f_i_l_l__.html" style="color:green">__FILL__</a> <span style="display:none;" id="eg1"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg1bf1" onclick='showPath("eg1","eg1bf1")'>bf1: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_b_f__l_e_g_e_n_d_r_e.html" style="color:green">BF_LEGENDRE</a> ...
   <div class="tooltip">ORDER<div class="right"><b>compulsory keyword </b>
The order of the basis function expansion. <i></i></div></div>=10 
   <div class="tooltip">MINIMUM<div class="right"><b>compulsory keyword </b>
The minimum of the interval on which the basis functions are defined. <i></i></div></div>=0.23 
   <div class="tooltip">MAXIMUM<div class="right"><b>compulsory keyword </b>
The maximum of the interval on which the basis functions are defined. <i></i></div></div>=0.8 
   
...<span style="display:none;" id="eg1bf1"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
</pre>
<p>We will use a uniform target distribution: </p><p class="formulaDsp">
\[ p(\mathbf{s})= 1/C \]
</p>
<p> with \( C \) a normalization constant. Once that \( \Omega [V] \) is minimized, the bias potential satisfies (up to an arbitrary constant): </p><p class="formulaDsp">
\[ V(\mathbf{s}) = - F(\mathbf{s}) \]
</p>
<p> This is the same relation that holds for non-tempered metadynamics.</p>
<p>The syntax for the bias potential in Plumed is: </p>
<div style="width: 90%; float:left" id="value_details_eg2"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.7-incomplete-yellow.svg" alt="tested on v2.7" /></div><pre style="width: 97%;" class="fragment">
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/___f_i_l_l__.html" style="color:green">__FILL__</a> <span style="display:none;" id="eg2"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg2td1" onclick='showPath("eg2","eg2td1")'>td1: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_t_d__u_n_i_f_o_r_m.html" style="color:green">TD_UNIFORM</a> <span style="display:none;" id="eg2td1"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg2b1" onclick='showPath("eg2","eg2b1")'>b1: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_v_e_s__l_i_n_e_a_r__e_x_p_a_n_s_i_o_n.html" style="color:green">VES_LINEAR_EXPANSION</a> ...
   <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=d1 
   <div class="tooltip">BASIS_FUNCTIONS<div class="right"><b>compulsory keyword </b>
the label of the one dimensional basis functions that should be used. <i></i></div></div>=bf1 
   <div class="tooltip">GRID_BINS<div class="right">the number of bins used for the grid. <i></i></div></div>=300 
   <div class="tooltip">TARGET_DISTRIBUTION<div class="right">the label of the target distribution to be used. <i></i></div></div>=<b name="eg2td1">td1</b> 
   
...<span style="display:none;" id="eg2b1"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
</pre>
<p>Finally we have to choose the optimization algorithm. The standard is the averaged stochastic gradient descent. One has to define two parameters: the stride and the step size. The stride is the number of steps in which samples are collected to calculate the gradient and hessian of \( \Omega [V] \) and the step size is the step by which the coefficients are evolved at every optimization steps. Both of this parameters are connected. Increasing the stride will have an effect similar to reducing the step size. It has become traditional to choose a stride of around 500-2000 steps. It must be noted that we are not looking for an accurate estimation of the gradient, since for this we would need to sample all the CV space. The step size in the optimization has a strong connection with the height of typical barriers in the system. The larger the barriers, the larger the step size needed such that the bias can grow fast enough to overcome them. For this example we have chosen a stride of 500 steps and a step size of 0.5 kJ/mol. The syntax in Plumed is: </p>
<div style="width: 90%; float:left" id="value_details_eg3"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.7-incomplete-yellow.svg" alt="tested on v2.7" /></div><pre style="width: 97%;" class="fragment">
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/___f_i_l_l__.html" style="color:green">__FILL__</a> <span style="display:none;" id="eg3"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg3o1" onclick='showPath("eg3","eg3o1")'>o1: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_o_p_t__a_v_e_r_a_g_e_d__s_g_d.html" style="color:green">OPT_AVERAGED_SGD</a> ...
   <div class="tooltip">BIAS<div class="right"><b>compulsory keyword </b>
the label of the VES bias to be optimized <i></i></div></div>=b1 
   <div class="tooltip">STRIDE<div class="right"><b>compulsory keyword </b>
the frequency of updating the coefficients given in the number of MD steps. <i></i></div></div>=500 
   
   <div class="tooltip">STEPSIZE<div class="right"><b>compulsory keyword </b>
the step size used for the optimization <i></i></div></div>=0.5 
   <div class="tooltip">FES_OUTPUT<div class="right">how often the FES(s) should be written out to file. <i></i></div></div>=100 
   <div class="tooltip">BIAS_OUTPUT<div class="right">how often the bias(es) should be written out to file. <i></i></div></div>=500 
   <div class="tooltip">COEFFS_OUTPUT<div class="right"><b>compulsory keyword ( default=100 )</b>
how often the coefficients should be written to file. <i></i></div></div>=10 
...<span style="display:none;" id="eg3o1"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
</pre>
<p>Now that we have set the scene, we can run our simulation using the run.sh script in the Example1 folder. The simulation will produce several files:</p>
<ul>
<li>COLVAR: Just as in the metadynamics example.</li>
<li>coeffs.data : Values of the coefficients \(\boldsymbol\alpha \) and \(\bar{\boldsymbol\alpha} \) .</li>
<li>bias.&lt;bias-name&gt;.iter-&lt;iteration-number&gt; : Bias potential as a function of \( \mathbf{s} \) at iteration &lt;iteration-number&gt;.</li>
<li>fes.&lt;bias-name&gt;.iter-&lt;iteration-number&gt; : FES at iteration &lt;iteration-number&gt;.</li>
<li>targetdistribution.&lt;bias-name&gt;.data : Target distribution.</li>
</ul>
<p>You can first observe how the system moves in the CV space in a fashion similar to metadynamics. Then we can see the evolution of \(\boldsymbol\alpha \) and \(\bar{\boldsymbol\alpha} \) . The first lines of the file coeffs.data are:</p>
<pre class="fragment">#! FIELDS idx_d1 b1.coeffs b1.aux_coeffs index
#! SET time 0.000000
#! SET iteration  0
#! SET type LinearBasisSet
#! SET ndimensions  1
#! SET ncoeffs_total  11
#! SET shape_d1  11
       0         0.0000000000000000e+00         0.0000000000000000e+00       0
       1         0.0000000000000000e+00         0.0000000000000000e+00       1
       2         0.0000000000000000e+00         0.0000000000000000e+00       2
       3         0.0000000000000000e+00         0.0000000000000000e+00       3
       4         0.0000000000000000e+00         0.0000000000000000e+00       4
       5         0.0000000000000000e+00         0.0000000000000000e+00       5
       6         0.0000000000000000e+00         0.0000000000000000e+00       6
       7         0.0000000000000000e+00         0.0000000000000000e+00       7
       8         0.0000000000000000e+00         0.0000000000000000e+00       8
       9         0.0000000000000000e+00         0.0000000000000000e+00       9
      10         0.0000000000000000e+00         0.0000000000000000e+00      10
#!-------------------




#! FIELDS idx_d1 b1.coeffs b1.aux_coeffs index
#! SET time 10.000000
#! SET iteration  10
#! SET type LinearBasisSet
#! SET ndimensions  1
#! SET ncoeffs_total  11
#! SET shape_d1  11
       0         0.0000000000000000e+00         0.0000000000000000e+00       0
       1         5.1165453234702052e-01         1.1482045941475065e+00       1
       2        -1.0356798763597277e+00        -1.7365051185667855e+00       2
       3        -5.1830527698835660e-01        -1.1651638070736938e+00       3
       4         4.1754103138162207e-01         4.8203393927719917e-01       4
       5         3.2087945211009694e-01         6.6606116920677805e-01       5
       6        -1.5499943980403830e-01        -4.7946750842365812e-03       6
       7        -1.1433825688016251e-01        -1.5099503286093419e-01       7
       8         9.8787914656136719e-02         1.3156529595420300e-02       8
       9         4.4467081175713474e-03        -8.7160339645570323e-02       9
      10        -1.1504176822089783e-01        -1.5789737594248379e-01      10
#!-------------------
</pre><p>The first column are the coefficient indices, the second are the \(\bar{\boldsymbol\alpha} \), and the third are the \(\boldsymbol\alpha \). Each block in the file corresponds to a different iteration, in this case iteration 0 and 10. We can plot the evolution of the coefficients using the gnuplot script plotCoeffs.gpi . The output should be similar to the next figure.</p>
<p><a class="anchor" id="ves-school-2017-ves1-coeffs1"></a></p><div class="image">
<img src="ves-lugano2017-ves1_coeffs1.png" alt=""/>
<div class="caption">
Evolution of the instantaneous and averaged coefficients with simulation time</div></div>
<p>The \(\boldsymbol\alpha \) change fast and oscillate around some mean value. The \(\bar{\boldsymbol\alpha} \) evolve smoothly until they stabilize around some equilibrium value. It is important to remember that the bias is a function of \(\bar{\boldsymbol\alpha} \) and since these evolve smoothly, so will the bias. Once that the \(\bar{\boldsymbol\alpha} \) have stabilized, the simulation can be considered converged.</p>
<p>It is also interesting to observe how the estimation of the FES evolves in time. For this we will plot the FES using the files fes.b1.iter-&lt;iteration-number&gt;. There is a gnuplot script plotFes.gpi that you can use for this purpose. At variance with metadynamics, in this case there is no growing offset in the bias and therefore we will have to shift the FES ourselves to distinguish several FES at different times in the same plot.</p>
<p><a class="anchor" id="ves-school-2017-ves1-fesEvolution"></a></p><div class="image">
<img src="ves-lugano2017-ves1_fesEvolution1.png" alt=""/>
<div class="caption">
Evolution of the estimated free energy</div></div>
<p>We can also calculate the height of the barrier as we did in the metadynamics tutorial. The files for carrying out this task can be found in the Barrier_calculation folder. Remember that the accuracy of this calculation is limited by the fact that we have chosen a small order in the basis set expansion. We will discuss this aspect in greater detail in the next example.</p>
<h2><a class="anchor" id="ves-lugano2017-ves1-subsection-3"></a>
Example 2: Target distributions and basis sets</h2>
<p>In this example we will consider other choices of target distributions and we will understand the influence of the order of the basis set expansion. The files needed for this example are contained in the directory Example2. Instead of introducing a barrier as done in the example above, in this case we will use a uniform target distribution in the interval [0.23:0.6] nm and decaying to zero in the interval [0.6:0.8] nm. The expression is:</p>
<p>MISSING EQUATION TO BE FIXED</p>
<p>where \( s_0=0.6\) nm and \( \sigma=0.05\). To define this \( p(s) \) in Plumed the input is: </p>
<div style="width: 90%; float:left" id="value_details_eg4"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.7-incomplete-yellow.svg" alt="tested on v2.7" /></div><pre style="width: 97%;" class="fragment">
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/___f_i_l_l__.html" style="color:green">__FILL__</a> <span style="display:none;" id="eg4"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg4td1" onclick='showPath("eg4","eg4td1")'>td1: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_t_d__u_n_i_f_o_r_m.html" style="color:green">TD_UNIFORM</a> <div class="tooltip">MINIMA<div class="right">The minimum of the intervals where the target distribution is taken as uniform. <i></i></div></div>=0.23 <div class="tooltip">MAXIMA<div class="right">The maximum of the intervals where the target distribution is taken as uniform. <i></i></div></div>=0.6 <div class="tooltip">SIGMA_MAXIMA<div class="right">The standard deviation parameters of the Gaussian switching functions for the maximum
of the intervals. <i></i></div></div>=0.05 <span style="display:none;" id="eg4td1"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg4b1" onclick='showPath("eg4","eg4b1")'>b1: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_v_e_s__l_i_n_e_a_r__e_x_p_a_n_s_i_o_n.html" style="color:green">VES_LINEAR_EXPANSION</a> ...
   <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=d1 
   <div class="tooltip">BASIS_FUNCTIONS<div class="right"><b>compulsory keyword </b>
the label of the one dimensional basis functions that should be used. <i></i></div></div>=bf1 
   
   <div class="tooltip">TEMP<div class="right">the system temperature - this is needed if the MD code does not pass the temperature
to PLUMED. <i></i></div></div>=300.0 
   <div class="tooltip">GRID_BINS<div class="right">the number of bins used for the grid. <i></i></div></div>=300 
   <div class="tooltip">TARGET_DISTRIBUTION<div class="right">the label of the target distribution to be used. <i></i></div></div>=<b name="eg4td1">td1</b> 
...<span style="display:none;" id="eg4b1"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
</pre>
<p>We will choose a basis set of order 20 to be able to capture the features of the FES with detail. If you are doing this example in a group, each member of the group can choose a different order in the expansion, for instance 5, 10, 20, and 40. The syntax in Plumed is: </p>
<div style="width: 90%; float:left" id="value_details_eg5"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.7-incomplete-yellow.svg" alt="tested on v2.7" /></div><pre style="width: 97%;" class="fragment">
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/___f_i_l_l__.html" style="color:green">__FILL__</a> <span style="display:none;" id="eg5"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg5bf1" onclick='showPath("eg5","eg5bf1")'>bf1: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_b_f__l_e_g_e_n_d_r_e.html" style="color:green">BF_LEGENDRE</a> ...
   <div class="tooltip">ORDER<div class="right"><b>compulsory keyword </b>
The order of the basis function expansion. <i></i></div></div>=20 
   <div class="tooltip">MINIMUM<div class="right"><b>compulsory keyword </b>
The minimum of the interval on which the basis functions are defined. <i></i></div></div>=0.23 
   <div class="tooltip">MAXIMUM<div class="right"><b>compulsory keyword </b>
The maximum of the interval on which the basis functions are defined. <i></i></div></div>=0.8 
   
...<span style="display:none;" id="eg5bf1"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
</pre>
<p>Once that you start running the simulation, a file named targetdist.b1.data will be created. This file contains the chosen target distribution. We can plot it to confirm that it is what we are looking for. There is a gnuplot script plotTargetDistrib.gpi that creates the following plot.</p>
<p><a class="anchor" id="ves-school-2017-ves1-targetDistrib"></a></p><div class="image">
<img src="ves-lugano2017-ves1_targetDistrib.png" alt=""/>
<div class="caption">
Target distribution for Example 2</div></div>
<p>As the simulation runs, it is useful to control the evolution of the coefficients using the gnuplot script plotCoeffs.gpi.</p>
<p>The FES is calculated from the expression: </p><p class="formulaDsp">
\[ F(\mathbf{s}) = -V(\mathbf{s})-{\frac {1}{\beta}} \log {p(\mathbf{s})} = \begin{cases} -V(s) \: &amp; \mathrm{if} \: s&lt;s_0 \\ -V(s) + \frac{(s-s_0)^2}{2\beta\sigma^2} \: &amp; \mathrm{if} \: s&gt;s_0\\ \end{cases} \]
</p>
<p> In other words the bias potential is forced to create the upper barrier that we were explicitly introducing in the first example. When the FES is calculated the effect of the barrier is "subtracted" through \( p(s) \) and therefore the FES that we calculate does not include the barrier. This can be seen by plotting the fes.b1.iter-&lt;iteration-number&gt; files with gnuplot, for instance: </p><pre class="fragment">pl "./fes.b1.iter-10000.data" u 1:2 w l
</pre><p> This plot should be similar to the next figure.</p>
<p><a class="anchor" id="ves-school-2017-ves1-fes"></a></p><div class="image">
<img src="ves-lugano2017-ves1_fes.png" alt=""/>
<div class="caption">
FES for Example 2</div></div>
<p>Only the interval [0.23:0.7] is plotted since there is little sampling in the region [0.7:0.8] due to the small value of \( p(s) \) in this region. As discussed before, if there is no sampling, it is not possible to obtain free energies.</p>
<p>When the simulation ends, it is interesting to check if in fact the sampled biased distribution is equal to the chosen target distribution. The scripts to calculate the sampled biased distribution are located in the directory BiasedDistribution. As usual, we will disregard the initial part of the simulation since in this period the bias is changing a lot. As done before, we get rid of the first 2 ns of simulation using sed: </p><pre class="fragment">sed '2,10000d' ../COLVAR &gt; COLVAR
</pre><p> Once that the coefficients in the expansion have stabilized it is possible to calculate the biased distribution of CVs by constructing a histogram with equal weights for all points. This distribution should be equal to the target distribution \( p(s) \). The histogram can be calculated in plumed using the following input in the plumed.dat file: </p>
<div style="width: 90%; float:left" id="value_details_eg6"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.7-incomplete-yellow.svg" alt="tested on v2.7" /></div><pre style="width: 97%;" class="fragment">
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/___f_i_l_l__.html" style="color:green">__FILL__</a> <span style="display:none;" id="eg6"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg6distance" onclick='showPath("eg6","eg6distance")'>distance: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_r_e_a_d.html" style="color:green">READ</a> <div class="tooltip">FILE<div class="right"><b>compulsory keyword </b>
the name of the file from which to read these quantities <i></i></div></div>=COLVAR <div class="tooltip">IGNORE_TIME<div class="right">( default=off ) ignore the time in the colvar file. <i></i></div></div> <div class="tooltip">VALUES<div class="right"><b>compulsory keyword </b>
the values to read from the file <i></i></div></div>=d1 <span style="display:none;" id="eg6distance"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg6hh1" onclick='showPath("eg6","eg6hh1")'>hh1: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_h_i_s_t_o_g_r_a_m.html" style="color:green">HISTOGRAM</a> ...
   <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<b name="eg6distance">distance</b> 
   <div class="tooltip">GRID_MIN<div class="right"><b>compulsory keyword </b>
the lower bounds for the grid <i></i></div></div>=0.2 
   <div class="tooltip">GRID_MAX<div class="right"><b>compulsory keyword </b>
the upper bounds for the grid <i></i></div></div>=0.8 
   <div class="tooltip">GRID_BIN<div class="right">the number of bins for the grid <i></i></div></div>=100 
   <div class="tooltip">BANDWIDTH<div class="right"><b>compulsory keyword </b>
the bandwidths for kernel density estimation <i></i></div></div>=0.004 
   
...<span style="display:none;" id="eg6hh1"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_d_u_m_p_g_r_i_d.html" style="color:green">DUMPGRID</a> <div class="tooltip">GRID<div class="right"><b>compulsory keyword </b>
the action that creates the grid you would like to output <i></i></div></div>=<b name="eg6hh1">hh1</b> <div class="tooltip">FILE<div class="right"><b>compulsory keyword ( default=density )</b>
the file on which to write the grid. <i></i></div></div>=histo <div class="tooltip">FMT<div class="right">the format that should be used to output real numbers <i></i></div></div>=%24.16e <span style="display:none;" id="eg6"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
</pre>
<p> and running (or using the run.sh script): </p><pre class="fragment">plumed --no-mpi driver --plumed plumed.dat --noatoms &gt; plumed.out
</pre><p> The next plot shows that in fact the sampled distribution agrees with the target distribution.</p>
<p><a class="anchor" id="ves-school-2017-ves1-biasedDistrib"></a></p><div class="image">
<img src="ves-lugano2017-ves1_biasedDistrib.png" alt=""/>
<div class="caption">
Sampled biased distribution of the distance Na-Cl and target distribution</div></div>
<p>Once that the coefficients are stabilized it is possible to reweight using the standard umbrella sampling formula <a class="el" href="citelist.html#CITEREF_torrie-valleau">[112]</a> . In this case the weight assigned to each configuration is: </p><p class="formulaDsp">
\[ w(\mathbf{R}) \propto e^{\beta V(\mathbf{s})}. \]
</p>
<p> The files needed for this reweighting are contained in the folder ReweightDistance. The procedure to the the reweighting and plot the results is similar to the ones in the cases above and therefore it is not described in detail. The reweighted FES is plotted in the next figure and compared to the FES calculated from the formula \( V(\mathbf{s}) = -F(\mathbf{s})-{\frac {1}{\beta}} \log {p(\mathbf{s})} \).</p>
<p><a class="anchor" id="ves-school-2017-ves1-reweight"></a></p><div class="image">
<img src="ves-lugano2017-ves1_reweight.png" alt=""/>
<div class="caption">
Comparison of the FES estimated from the bias and p(s), and the reweighted FES</div></div>
<p>The two curves do not differ much since the order of the expansion was relatively large. What happens if you chose a lower or higher order in the expansion?</p>
<h2><a class="anchor" id="ves-lugano2017-ves1-subsection-4"></a>
Restarting a simulation</h2>
<p>In this section we will restart the simulation that we have performed in our second example. In directory Example2, cd to the folder Restart. To restart the simulation we will need:</p>
<ul>
<li>LAMMPS restart file, since it stores the last configuration</li>
<li>COLVAR file, since new lines will be appended</li>
<li>coeff.data file, containing the iteration number and the values of the coefficients.</li>
</ul>
<p>Therefore we execute in the command line the following commands: </p><pre class="fragment">cp ../restart .
cp ../COLVAR .
cp ../coeffs.data .
</pre><p>In order to restart, the RESTART keyword must be added at the beginning of the input file for PLUMED named plumed.restart.dat: </p><pre class="fragment">RESTART

d1:  DISTANCE ATOMS=319,320
.
.
.
</pre><p>Then the simulation can be restarted using the script runRestart.sh . Check that the output of the new simulation is appended to the COLVAR file, that the starting time of the new simulation is the ending time of the old simulation, that CV values are coherent, and that coefficients evolve continuously.</p>
<h2><a class="anchor" id="ves-lugano2017-ves1-subsection-5"></a>
Gaussian target distribution</h2>
<p>As an exercise, you can use a target distribution consisting in a gaussian centered at the dissociation barrier. The syntax in Plumed is: </p>
<div style="width: 90%; float:left" id="value_details_eg7"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.7-incomplete-yellow.svg" alt="tested on v2.7" /></div><pre style="width: 97%;" class="fragment">
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/___f_i_l_l__.html" style="color:green">__FILL__</a> <span style="display:none;" id="eg7"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg7td1" onclick='showPath("eg7","eg7td1")'>td1: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_t_d__g_a_u_s_s_i_a_n.html" style="color:green">TD_GAUSSIAN</a> <div class="tooltip">CENTER1<div class="right">The centers of the Gaussian distributions. <i></i></div></div>=0.325 <div class="tooltip">SIGMA1<div class="right">The standard deviations of the Gaussian distributions. <i></i></div></div>=0.03 <span style="display:none;" id="eg7td1"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg7b1" onclick='showPath("eg7","eg7b1")'>b1: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_v_e_s__l_i_n_e_a_r__e_x_p_a_n_s_i_o_n.html" style="color:green">VES_LINEAR_EXPANSION</a> ...
   <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=d1 
   <div class="tooltip">BASIS_FUNCTIONS<div class="right"><b>compulsory keyword </b>
the label of the one dimensional basis functions that should be used. <i></i></div></div>=bf1 
   
   <div class="tooltip">TEMP<div class="right">the system temperature - this is needed if the MD code does not pass the temperature
to PLUMED. <i></i></div></div>=300.0 
   <div class="tooltip">GRID_BINS<div class="right">the number of bins used for the grid. <i></i></div></div>=300 
   <div class="tooltip">TARGET_DISTRIBUTION<div class="right">the label of the target distribution to be used. <i></i></div></div>=<b name="eg7td1">td1</b> 
...<span style="display:none;" id="eg7b1"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
</pre>
<p>Gaussian target distributions are useful to focus the sampling on a particular region of CV space. This has been used in protein folding problems to focus the sampling on the small but relevant folded state <a class="el" href="citelist.html#CITEREF_Shaffer-PNAS-2016">[102]</a>.</p>
<h2><a class="anchor" id="ves-lugano2017-ves1-subsection-6"></a>
Optimization algorithm</h2>
<p>We suggest an exercise to gain experience in choosing the parameters of the optimization algorithm. The averaged stochastic gradient descent algorithm has two parameters: the stride and the step size. Normally a stride of around 500-2000 steps is used. However it is not always easy to choose the step size. Luckily, the algorithm is quite robust and will work for different step sizes.</p>
<p>Run different simulation using step sizes \( \mu = 0.001 \) and \( \mu = 10 \) and try to rationalize the behavior. Normally, when the step size is too large, the system gets stuck in CV space and coefficients oscillate wildly. When the step size is too small, the algorithm runs out of "steam" too fast and the simulation converges slowly. These two extreme cases should be avoided.</p>
<h1><a class="anchor" id="ves-lugano2017-ves1-final"></a>
Final remarks</h1>
<p>The purpose of this first tutorial was to introduce the student to VES. At this point one can see that VES is a powerful and versatile enhanced sampling method. We suggest to explore different possibilities of basis sets and target distributions. It is also interesting to experiment with different optimization algorithms and parameters of these.</p>
<p>The next tutorial will deal with the use of the well-tempered target distribution and the construction of biases on 2 CVs. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.3.1-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
<!--    <li class="navelem"><a class="el" href="_add_mod.html">Additional Modules</a></li><li class="navelem"><a class="el" href="_v_e_s.html">Variationally Enhanced Sampling (VES code)</a></li><li class="navelem"><a class="el" href="ves_tutorials.html">Tutorials</a></li>  -->
    <li class="footer">   <!--- Generated by -->
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
