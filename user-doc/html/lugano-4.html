<!-- HTML header for doxygen 1.8.3.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta name="robots" content="noindex">
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<title>PLUMED: Lugano tutorial: Calculating error bars</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<script>
   var redpath = "";
   
   function showPath(eg,name) {
     var i; var y = document.getElementsByName(redpath);
     for (i=0; i < y.length; i++ ) { y[i].style.color="black"; }
     var x = document.getElementsByName(name); redpath=name;
     for (i = 0; i < x.length; i++) { x[i].style.color="red"; }
     var valid="value_details_".concat(eg);
     var valueField = document.getElementById(valid);
     var dataField = document.getElementById(name);
     valueField.innerHTML = dataField.innerHTML;
   }
   function swapInput(name) {
     var btn = document.getElementById(name + "_button");
     var mydiv = document.getElementById("input_" + name);
     if( btn.textContent=="expand shortcuts" ) {
         btn.textContent = "contract shortcuts";
         var dataField = document.getElementById(name + "long");
         mydiv.innerHTML = dataField.innerHTML;
     } else if( btn.textContent=="contract shortcuts" ) {
         btn.textContent = "expand shortcuts";
         var dataField = document.getElementById(name + "short");
         mydiv.innerHTML = dataField.innerHTML;
     }
   }
</script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table align="center" frame="void" width="98%" cellpadding="2%">
<tbody>
<tr style="height: 30px;">
<td valign="center"> &nbsp; <img src="pigeon.png" width="120"/></td>
<td style="padding-left: 0.2em;" width="74%"> <a href="http://www.plumed.org"> <img src="logo.png" width="400" /> </td>
<td style="padding-left: 0.2em;" align="right"> <a href="../../developer-doc/html/index.html"> <img src="user-logo.png" width="180" /> </a> </td>
</tr>
</tbody>
</table>
<!--
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">PLUMED
   &#160;<span id="projectnumber">2.7b</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
-->
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('lugano-4.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Lugano tutorial: Calculating error bars </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="lugano-4-aim"></a>
Aims</h1>
<p>This tutorial will teach you how to use block averaging techniques to compute the error bars on the estimates for the ensemble average and the free energy that you obtain from a biased simulation. Please note that the ensemble averages that you obtain from simulations are always estimates and that you should thus <b>always</b> endeavor to provide an estimate of the error bar.</p>
<h1><a class="anchor" id="lugano-4-lo"></a>
Objectives</h1>
<p>Once this tutorial is completed students will</p>
<ul>
<li>Be able to explain why it is important to compute error bars when calculating averages and free energy surfaces from enhanced sampling calculations.</li>
<li>Be able to use PLUMED to calculate ensemble averages and histograms using the keywords <a class="el" href="_a_v_e_r_a_g_e.html">AVERAGE</a> and <a class="el" href="_h_i_s_t_o_g_r_a_m.html">HISTOGRAM</a>.</li>
<li>Be able to use PLUMED to perform block analysis of trajectory data using the keywords <a class="el" href="_a_v_e_r_a_g_e.html">AVERAGE</a> and <a class="el" href="_h_i_s_t_o_g_r_a_m.html">HISTOGRAM</a>.</li>
<li>Be able to explain how block analysis can be used to detect problems with error bar underestimation in correlated data.</li>
</ul>
<h1><a class="anchor" id="lugano-4-resources"></a>
Resources</h1>
<p>The <span style="background-color:yellow"><a href="tutorial-resources/lugano-4.tar.gz" style="font-weight:bold" style="color:green" download="lugano-4.tar.gz">TARBALL</a> </span> for this project contains the following files:</p>
<ul>
<li>in : The input file for simplemd that contains the parameters for the MD simulation.</li>
<li>input.xyz : An initial configuration for the cluster that we are studying in this tutorial.</li>
<li>plumed.dat : An empty input file for PLUMED</li>
</ul>
<p>This tutorial has been tested on v2.5 but it should also work with other versions of PLUMED.</p>
<p>Also notice that the <code>.solutions</code> direction of the tarball contains correct input files for the exercises. Please only look at these files once you have tried to solve the problems yourself. Similarly the tutorial below contains questions for you to answer that are shown in bold. You can reveal the answers to these questions by clicking on links within the tutorial but you should obviously try to answer things yourself before reading these answers.</p>
<h1><a class="anchor" id="lugano-4-intro"></a>
Introduction</h1>
<p>In this tutorial we are going to study a very simple physical system; namely, seven Lennard Jones atoms in a two dimensional space. This simple system has been extensively studied as has often been used to benchmark new simulation techniques. In addition, the potential energy landscape has been fully characterized and it is known that only the four structurally-distinct minima shown below exist:</p>
<p><a class="anchor" id="lugano-4-lj7-minima"></a></p><div class="image">
<img src="lyon-lj7-minima.png" alt=""/>
<div class="caption">
The four energetic minima in the energy landscape for two-dimensional Lennard Jones 7.</div></div>
<p>In the exercises that follow we are going to learn how to use PLUMED to determine the relative free energies of these four structures by running molecular dynamics simulations as well as how to find suitable error bars on the energy of these minima. First of all, however, we are going to learn how to estimate the average energy of this system and how to compute the error on our estimate for the average. We will thus start with a very brief recap of the theory behind taking an ensemble average.</p>
<h1><a class="anchor" id="lugano-4-background"></a>
Background</h1>
<p>When performing unbiased and biased simulations the aim is <b> always </b> to estimate the ensemble average for some quantity \(\langle A \rangle\). We know from statistical mechanics that, if we are in the canonical (NVT) ensemble, the value of this ensemble average is given by: </p><p class="formulaDsp">
\[ \langle A \rangle = \frac{ \int \textrm{d}x \textrm{d}p A(x) e^{-\frac{H(x,p)}{k_B T}} }{ \int \textrm{d}x\textrm{d}p e^{-\frac{H(x,p)}{k_B T}} } \]
</p>
<p> where \(H(x,p)\) is the Hamiltonian for our system, \(T\) is the temperature and \(k_B\) is the Boltzmann constant. We also know, however, that for all but the simplest possible systems, it is impossible to solve the integrals in this expression analytically. Furthermore, because this expression involves integrals over all the \(3N\) position and \(3N\) momentum coordinates, using a numerical integration method that employs a set of regularly spaced grid points in the \(6N\) dimensional phase space would be prohibitively expensive. We are thus forced to instead generate a time series of random variables and to approximate the ensemble average using: </p><p class="formulaDsp">
\[ \langle A \rangle \approx \frac{1}{T} \sum_{t=1}^T A_t \qquad \qquad \textrm{Equation 1} \]
</p>
<p> where each \(A_t\) in the expression above is a sample from the distribution: </p><p class="formulaDsp">
\[ P(A_t = a ) = \frac{ \int \textrm{d}x \textrm{d}p \delta(A(x)-a) e^{-\frac{H(x,p)}{k_B T}} }{ \int \textrm{d}x\textrm{d}p e^{-\frac{H(x,p)}{k_B T}} } \]
</p>
<p> This distribution (thankfully) is exactly the distribution we are sampling from if we compute the values the observable \(A\) takes during the course of in an equilibrated molecular dynamics trajectory. We can thus calculate an approximate value for \(\langle A\rangle\) by computing the value of \(A\) for each of the frames in our trajectory and by computing the average value that \(A\) takes over the trajectory using equation 1. It is critical to remember, however, that the value we obtain for \(\langle A\rangle\) when we compute it this way is itself a random variable. When reporting ensemble averages calculated in this way we should thus endeavor to quantify the error in our estimate of this quantity by computing multiple estimates for \(\langle A\rangle\) and by using these multiple estimates to compute a variance for the underlying random variable. This tutorial will explain how this such error bars are computed in practice. At some stage you may find it useful to watch the following videos in order to understand the theory that is behind these calculations a little better. <br  />
</p>
<p> 
<table>
<tr>
<td><iframe width="560" height="315" src="https://www.youtube.com/embed/LOFnWyocr40" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></td>
<td> <iframe width="560" height="315" src="https://www.youtube.com/embed/0KqCK0yG9T0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe> </td> 
</tr>
</table> 
</p>
<h1><a class="anchor" id="lugano-4-s"></a>
Getting started</h1>
<h2><a class="anchor" id="lugano-4-simplemd"></a>
Using PLUMED as an MD code</h2>
<p>Before getting into the business of computing an ensemble average we first need to setup the system we are going to study. In this tutorial we are going to use the MD code <b>simplemd</b> that is part of PLUMED. You can run this code by issuing the command:</p>
<pre class="fragment">plumed simplemd &lt; in
</pre><p>where in here is the input file from the tar ball for this tutorial, which is shown below:</p>
<pre class="fragment">nputfile input.xyz
outputfile output.xyz
temperature 0.5
tstep 0.005
friction 0.1
forcecutoff 2.5
listcutoff  3.0
ndim 2
nstep 200000
nconfig 1000 trajectory.xyz
nstat   1000 energies.dat
</pre><p>This input instructs PLUMED to perform 200000 steps of MD at a temperature of \(k_B T = 0.5 \epsilon\) starting from the configuration in input.xyz. The timestep in this simulation is 0.005 \(\sqrt{\epsilon}{m\sigma^2}\) and the temperature is kept fixed using a Langevin thermostat with a relaxation time of \(0.1 \sqrt{\epsilon}{m\sigma^2}\). Trajectory frames are output every 1000 MD steps to a file called trajectory.xyz. Notice also that in order to run the calculation above you need to provide an empty file called plumed.dat. This file is the input file to the PLUMED plugin, which, because this file is empty, is doing nothing when we run the calculation above.</p>
<p><b> Run a calculation using simplemd and the input above and visualize the trajectory that is output. Describe what happens during this calculation and explain why this is happening. </b></p>
<p> <details> <summary> <b> To learn more: What happens </b> </summary> <div class="hidden">  You can visualize what occurs during the trajectory by using a visualization package such as VMD (<a href="https://www.ks.uiuc.edu/Research/vmd/">https://www.ks.uiuc.edu/Research/vmd/</a>). If you are using VMD you can see the MD trajectory by using the command:</p>
<pre class="fragment">vmd trajectory.xyz
</pre><p>You should observe that all the atoms fly apart early on in the simulation and that the cluster evaporates. The cluster evaporates because at a temperature of \(k_B T = 0.5 \epsilon\) the gas state has a lower free energy than than the cluster state.  </div> </details> </p>
<p><b> Change the parameters in the input file for simplemd so as to prevent the cluster from evaporating. </b></p>
<p> <details> <summary> <b> To learn more: No evaporation </b> </summary> <div class="hidden">  To prevent the cluster from evaporating you need to lower the temperature in the file in. The cluster will not evaporate if the temperature is set equal to \(k_B T = 0.2 \epsilon\).  </div> </details> </p>
<p><b> Now try to think how we can use a bias potential to stop the cluster from evaporating. Why might using a bias potential be preferable to the method that you have just employed? N.B. The next exercise is in the hidden section below so you need to expand it. Please try to come up with your own answer to the question of what bias potential we should be using before expanding this section by thinking about the material that was covered in <a class="el" href="lugano-2.html">Lugano tutorial: Using restraints</a>. </b></p>
<p> <details> <summary> <b> To learn more: The bias potential </b> </summary> <div class="hidden">  If we lower the temperature of the simulation very little will happen. Yes the cluster will no longer evaporate but at the same time we will not see any transitions between the various basins in this energy landscape. We thus can use a bias potential to prevent the cluster from exploring gaseous configurations that do not interest us instead of lowering the temperature. In other words, we are going to add restraints that will prevent the cluster from evaporating. The particular restraint we are going to use will prevent all the atoms from moving more than \(2\sigma\) from the center of mass of the cluster. As the masses of all the atoms in the cluster are the same we can compute the position of the center of mass using: </p><p class="formulaDsp">
\[ \mathbf{x}_\textrm{com} = \frac{1}{N} \sum_{i=1}^N \mathbf{x}_i \]
</p>
<p> where \(\mathbf{x}_i\) is the position of the atom with the index \(i\). The distance between the atom with index \(i\) and the position of this center of mass, \(d_i\), can be computed using Pythagoras' theorem. These distances are then restrained by using the following potential: </p><p class="formulaDsp">
\[ V(d_i) = \begin{cases} 100*(d_i-2.0)^2 &amp; \textrm{if} \quad d_i &gt; 2 \\ 0 &amp; \textrm{otherwise} \end{cases} \]
</p>
<p> as you can see this potential has no effect on the dynamics when these distances are less than 2 \(\epsilon\). If any atom is more than 2 \(\epsilon\) from the center of mass, however, this potential will drive it back towards the center of mass. The following cell contains a skeleton input file for PLUMED that gets it to calculate and apply this bias potential.</p>

<div style="width: 90%; float:left" id="value_details_eg1"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.7-incomplete-yellow.svg" alt="tested on v2.7" /></div><pre style="width: 97%;" class="fragment">
<span style="color:blue"># this optional command tells VIM that this is a PLUMED file and to color the text accordingly</span>
<span style="color:blue"># vim: ft=plumed</span>
<span style="color:blue"># This tells PLUMED we are using Lennard Jones units</span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_u_n_i_t_s.html" style="color:green">UNITS</a> <div class="tooltip">NATURAL<div class="right">( default=off ) use natural units <i></i></div></div> <span style="display:none;" id="eg1"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Calculate the position of the center of mass. We can then refer to this position later in the input using the label com.</span>
<b name="eg1com" onclick='showPath("eg1","eg1com")'>com: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_c_o_m.html" style="color:green">COM</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg1com"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Add the restraint on the distance between com and the first atom</span>
<b name="eg1d1" onclick='showPath("eg1","eg1d1")'>d1: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_d_i_s_t_a_n_c_e.html" style="color:green">DISTANCE</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg1d1"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_u_p_p_e_r__w_a_l_l_s.html" style="color:green">UPPER_WALLS</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<b name="eg1d1">d1</b> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg1"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Add the restraint on the distance between com and the second atom</span>
<b name="eg1d2" onclick='showPath("eg1","eg1d2")'>d2: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_d_i_s_t_a_n_c_e.html" style="color:green">DISTANCE</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg1d2"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_u_p_p_e_r__w_a_l_l_s.html" style="color:green">UPPER_WALLS</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg1"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Add the restraint on the distance between com and the third atom</span>
<b name="eg1d3" onclick='showPath("eg1","eg1d3")'>d3: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_d_i_s_t_a_n_c_e.html" style="color:green">DISTANCE</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg1d3"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_u_p_p_e_r__w_a_l_l_s.html" style="color:green">UPPER_WALLS</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg1"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Add the restraint on the distance between com and the fourth atom</span>
<b name="eg1d4" onclick='showPath("eg1","eg1d4")'>d4: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_d_i_s_t_a_n_c_e.html" style="color:green">DISTANCE</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg1d4"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_u_p_p_e_r__w_a_l_l_s.html" style="color:green">UPPER_WALLS</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg1"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Add the restraint on the distance between com and the fifth atom</span>
<b name="eg1d5" onclick='showPath("eg1","eg1d5")'>d5: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_d_i_s_t_a_n_c_e.html" style="color:green">DISTANCE</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg1d5"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_u_p_p_e_r__w_a_l_l_s.html" style="color:green">UPPER_WALLS</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg1"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Add the restraint on the distance between com and the sixth atom</span>
<b name="eg1d6" onclick='showPath("eg1","eg1d6")'>d6: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_d_i_s_t_a_n_c_e.html" style="color:green">DISTANCE</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg1d6"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_u_p_p_e_r__w_a_l_l_s.html" style="color:green">UPPER_WALLS</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg1"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Add the restraint on the distance between com and the seventh atom</span>
<b name="eg1d7" onclick='showPath("eg1","eg1d7")'>d7: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_d_i_s_t_a_n_c_e.html" style="color:green">DISTANCE</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg1d7"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_u_p_p_e_r__w_a_l_l_s.html" style="color:green">UPPER_WALLS</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg1"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
</pre>
<p><b> Copy and paste the content above into the file plumed.dat and then fill in the blanks by looking up the documentation for these actions online and by reading the description of the calculation that you are to run above. Once you have got a working plumed.dat file run a calculation using simplemd again at a temperature of \(k_B T = 0.5 \epsilon\) and check to see if the bias potential is indeed preventing the cluster from evaporating. </b> </div> </details> </p>
<h1><a class="anchor" id="lugano-4-blocks"></a>
Block averaging</h1>
<p>The previous sections showed you how to set up the simulations of the Lennard Jones cluster and reviewed some of the material on adding static bias potentials that was covered in the earlier hands-on sessions in the meeting. Now that we have completed all this we can move to the material on calculating appropriate error bars that we will cover in this tutorial. In this section you are going to work through the process of block averaging the trajectory yourself for a simple case in order to better understand the theory. In the final section we will then apply this technique to a more complex case. Without further ado then lets run a trajectory and collect some data to analyze. <br  />
</p>
<p><b> Run a simulation of the Lennard Jones cluster at \(k_B T = 0.2 \epsilon\) using for 12000 steps using the input file below (but with the blanks filled in obviously). This calculation outputs the potential energy of the system for every tenth step in the trajectory to a file called energy. </b></p>

<div style="width: 90%; float:left" id="value_details_eg2"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.7-incomplete-yellow.svg" alt="tested on v2.7" /></div><pre style="width: 97%;" class="fragment">
<span style="color:blue"># this optional command tells VIM that this is a PLUMED file and to color the text accordingly</span>
<span style="color:blue"># vim: ft=plumed</span>
<span style="color:blue"># This tells PLUMED we are using Lennard Jones units</span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_u_n_i_t_s.html" style="color:green">UNITS</a> <div class="tooltip">NATURAL<div class="right">( default=off ) use natural units <i></i></div></div> <span style="display:none;" id="eg2"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Calculate the position of the center of mass. We can then refer to this position later in the input using the label com.</span>
<b name="eg2com" onclick='showPath("eg2","eg2com")'>com: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_c_o_m.html" style="color:green">COM</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg2com"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Add the restraint on the distance between com and the first atom</span>
<b name="eg2d1" onclick='showPath("eg2","eg2d1")'>d1: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_d_i_s_t_a_n_c_e.html" style="color:green">DISTANCE</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg2d1"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_u_p_p_e_r__w_a_l_l_s.html" style="color:green">UPPER_WALLS</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<b name="eg2d1">d1</b> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg2"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Add the restraint on the distance between com and the second atom</span>
<b name="eg2d2" onclick='showPath("eg2","eg2d2")'>d2: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_d_i_s_t_a_n_c_e.html" style="color:green">DISTANCE</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg2d2"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_u_p_p_e_r__w_a_l_l_s.html" style="color:green">UPPER_WALLS</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg2"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Add the restraint on the distance between com and the third atom</span>
<b name="eg2d3" onclick='showPath("eg2","eg2d3")'>d3: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_d_i_s_t_a_n_c_e.html" style="color:green">DISTANCE</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg2d3"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_u_p_p_e_r__w_a_l_l_s.html" style="color:green">UPPER_WALLS</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg2"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Add the restraint on the distance between com and the fourth atom</span>
<b name="eg2d4" onclick='showPath("eg2","eg2d4")'>d4: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_d_i_s_t_a_n_c_e.html" style="color:green">DISTANCE</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg2d4"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_u_p_p_e_r__w_a_l_l_s.html" style="color:green">UPPER_WALLS</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg2"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Add the restraint on the distance between com and the fifth atom</span>
<b name="eg2d5" onclick='showPath("eg2","eg2d5")'>d5: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_d_i_s_t_a_n_c_e.html" style="color:green">DISTANCE</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg2d5"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_u_p_p_e_r__w_a_l_l_s.html" style="color:green">UPPER_WALLS</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg2"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Add the restraint on the distance between com and the sixth atom</span>
<b name="eg2d6" onclick='showPath("eg2","eg2d6")'>d6: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_d_i_s_t_a_n_c_e.html" style="color:green">DISTANCE</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg2d6"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_u_p_p_e_r__w_a_l_l_s.html" style="color:green">UPPER_WALLS</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg2"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Add the restraint on the distance between com and the seventh atom</span>
<b name="eg2d7" onclick='showPath("eg2","eg2d7")'>d7: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_d_i_s_t_a_n_c_e.html" style="color:green">DISTANCE</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg2d7"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_u_p_p_e_r__w_a_l_l_s.html" style="color:green">UPPER_WALLS</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg2"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Get the potential energy</span>
<b name="eg2e" onclick='showPath("eg2","eg2e")'>e: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_e_n_e_r_g_y.html" style="color:green">ENERGY</a> <span style="display:none;" id="eg2e"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Print the potential energy to a file</span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_p_r_i_n_t.html" style="color:green">PRINT</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">FILE<div class="right">the name of the file on which to output these quantities <i></i></div></div>=energy <div class="tooltip">STRIDE<div class="right"><b>compulsory keyword ( default=1 )</b>
the frequency with which the quantities of interest should be output <i></i></div></div>=10 <span style="display:none;" id="eg2"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
</pre>
<p>The exercise below will take you through the process of calculating block averages and hence error bars on the data you generated.</p>
<p> 
<iframe frameborder="0" width="100%" height="600px" src="https://repl.it/student_embed/classroom/138484/b1c05b5ed64d50f1098190481877a402"></iframe>
</p>
<p>Notice that we can calculate the block averages that were required for the block averaging technique that was explained in the programming exercise using PLUMED directly. The input below (once you fill in the gaps) calculates and prints block averages over windows of 100 trajectory frames. See if you can fill in the blanks and compare the result you obtain with the result that you obtain by running a python script to convince yourself that PLUMED calculates these block averages correctly.</p>

<div style="width: 90%; float:left" id="value_details_eg3"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.7-incomplete-yellow.svg" alt="tested on v2.7" /></div><pre style="width: 97%;" class="fragment">
<span style="color:blue"># this optional command tells VIM that this is a PLUMED file and to color the text accordingly</span>
<span style="color:blue"># vim: ft=plumed</span>
<span style="color:blue"># This tells PLUMED we are using Lennard Jones units</span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_u_n_i_t_s.html" style="color:green">UNITS</a> <div class="tooltip">NATURAL<div class="right">( default=off ) use natural units <i></i></div></div> <span style="display:none;" id="eg3"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Calculate the position of the center of mass. We can then refer to this position later in the input using the label com.</span>
<b name="eg3com" onclick='showPath("eg3","eg3com")'>com: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_c_o_m.html" style="color:green">COM</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg3com"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Add the restraint on the distance between com and the first atom</span>
<b name="eg3d1" onclick='showPath("eg3","eg3d1")'>d1: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_d_i_s_t_a_n_c_e.html" style="color:green">DISTANCE</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg3d1"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_u_p_p_e_r__w_a_l_l_s.html" style="color:green">UPPER_WALLS</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<b name="eg3d1">d1</b> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg3"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Add the restraint on the distance between com and the second atom</span>
<b name="eg3d2" onclick='showPath("eg3","eg3d2")'>d2: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_d_i_s_t_a_n_c_e.html" style="color:green">DISTANCE</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg3d2"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_u_p_p_e_r__w_a_l_l_s.html" style="color:green">UPPER_WALLS</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg3"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Add the restraint on the distance between com and the third atom</span>
<b name="eg3d3" onclick='showPath("eg3","eg3d3")'>d3: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_d_i_s_t_a_n_c_e.html" style="color:green">DISTANCE</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg3d3"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_u_p_p_e_r__w_a_l_l_s.html" style="color:green">UPPER_WALLS</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg3"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Add the restraint on the distance between com and the fourth atom</span>
<b name="eg3d4" onclick='showPath("eg3","eg3d4")'>d4: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_d_i_s_t_a_n_c_e.html" style="color:green">DISTANCE</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg3d4"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_u_p_p_e_r__w_a_l_l_s.html" style="color:green">UPPER_WALLS</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg3"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Add the restraint on the distance between com and the fifth atom</span>
<b name="eg3d5" onclick='showPath("eg3","eg3d5")'>d5: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_d_i_s_t_a_n_c_e.html" style="color:green">DISTANCE</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg3d5"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_u_p_p_e_r__w_a_l_l_s.html" style="color:green">UPPER_WALLS</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg3"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Add the restraint on the distance between com and the sixth atom</span>
<b name="eg3d6" onclick='showPath("eg3","eg3d6")'>d6: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_d_i_s_t_a_n_c_e.html" style="color:green">DISTANCE</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg3d6"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_u_p_p_e_r__w_a_l_l_s.html" style="color:green">UPPER_WALLS</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg3"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Add the restraint on the distance between com and the seventh atom</span>
<b name="eg3d7" onclick='showPath("eg3","eg3d7")'>d7: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_d_i_s_t_a_n_c_e.html" style="color:green">DISTANCE</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg3d7"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_u_p_p_e_r__w_a_l_l_s.html" style="color:green">UPPER_WALLS</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg3"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Get the potential energy</span>
<b name="eg3e" onclick='showPath("eg3","eg3e")'>e: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_e_n_e_r_g_y.html" style="color:green">ENERGY</a> <span style="display:none;" id="eg3e"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Calculate block averages of the potential energy</span>
<b name="eg3av_e" onclick='showPath("eg3","eg3av_e")'>av_e: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_a_v_e_r_a_g_e.html" style="color:green">AVERAGE</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">CLEAR<div class="right"><b>compulsory keyword ( default=0 )</b>
the frequency with which to clear all the accumulated data. <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">STRIDE<div class="right"><b>compulsory keyword ( default=1 )</b>
the frequency with which the data should be collected and added to the quantity being
averaged <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <span style="display:none;" id="eg3av_e"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Print the block averages of the potential energy to a file</span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_p_r_i_n_t.html" style="color:green">PRINT</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">STRIDE<div class="right"><b>compulsory keyword ( default=1 )</b>
the frequency with which the quantities of interest should be output <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">FILE<div class="right">the name of the file on which to output these quantities <i></i></div></div>=energy <span style="display:none;" id="eg3"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
</pre>
<p>At some point (probably not during the tutorial as you will not have time) you can use the following video and quiz to understand the theory behind this process of block averaging.</p>
<h1><a class="anchor" id="lugano-4-together"></a>
Calculating the free energy surface</h1>
<p>In this final exercise we are going to run a metadynamics simulation in order to see the Lennard Jones cluster explore all of the basins in the energy landscape that were shown in figure <a class="el" href="lugano-4.html#lugano-4-lj7-minima">lugano-4-lj7-minima</a>. We will extract a free energy surface from this simulation trajectory and will use the block averaging technique that we learnt about in the previous section to quote error bars on this free energy surface. There are three important differences between the way we apply the block averaging techinique in this section and the way that we applied the block averaging technique in the previous section; namely:</p>
<ul>
<li>The block averaging technique is applied on on the histogram that is estimated from the simulation. As the free energy surface is a function of the histogram we have do some propegation of errors to get the final error bar.</li>
<li>The free energy surface we are extracting <b> is not </b> a single number as it was in the previous section. It is a function evaluated on the grid. We thus have to apply the block averaging technique for the value of the free energy at each grid point separately.</li>
<li>The simulation in this case is biased so we have to reweight in order to get the unbiased free energy surface.</li>
</ul>
<p>We will not dwell too much on these issues in what follows. For the interested reader they are discussed at length in <a href="https://arxiv.org/abs/1812.08213">https://arxiv.org/abs/1812.08213</a>. Furthermore, the <a class="el" href="trieste-2.html">Trieste tutorial: Averaging, histograms and block analysis</a> tutorial deals with each of these issues in turn. If you have sufficient time at the end you may therefore like to work through the exercises in that tutorial in order to better understand how the block averaging technique that was discussed in the previous section has been extended so as to resolve these issues.</p>
<h2><a class="anchor" id="luganoo-4-metad"></a>
Running the metadynamics simulation</h2>
<p>We can drive transitions between the four possible minima in the Lennard-Jones-seven potential energy landscape by biasing the second and third central moments of the distribution of coordination numbers. The nth central moment of a set of numbers, \(\{X_i\}\) can be calculated using: </p><p class="formulaDsp">
\[ \mu^n = \frac{1}{N} \sum_{i=1}^N ( X_i - \langle X \rangle )^n \qquad \textrm{where} \qquad \langle X \rangle = \frac{1}{N} \sum_{i=1}^N X_i \]
</p>
<p> Furthermore, we can compute the coordination number of our Lennard Jones atoms using: </p><p class="formulaDsp">
\[ c_i = \sum_{i \ne j } \frac{1 - \left(\frac{r_{ij}}{1.5}\right)^8}{1 - \left(\frac{r_{ij}}{1.5}\right)^{16} } \]
</p>
<p> where \(r_{ij}\)__FILL__ is the distance between atom \(i\) and atom \(j\). The following cell contains a skeleton input file for PLUMED that gets it to perform metadynamics using the second and third central moments of the distribution of coordination numbers as a CV.</p>

<div style="width: 90%; float:left" id="value_details_eg4"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.7-incomplete-yellow.svg" alt="tested on v2.7" /></div><pre style="width: 97%;" class="fragment">
<span style="color:blue"># this optional command tells VIM that this is a PLUMED file and to color the text accordingly</span>
<span style="color:blue"># vim: ft=plumed</span>
<span style="color:blue"># This tells PLUMED we are using Lennard Jones units</span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_u_n_i_t_s.html" style="color:green">UNITS</a> <div class="tooltip">NATURAL<div class="right">( default=off ) use natural units <i></i></div></div> <span style="display:none;" id="eg4"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Calculate the position of the center of mass. We can then refer to this position later in the input using the label com.</span>
<b name="eg4com" onclick='showPath("eg4","eg4com")'>com: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_c_o_m.html" style="color:green">COM</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg4com"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Add the restraint on the distance between com and the first atom</span>
<b name="eg4d1" onclick='showPath("eg4","eg4d1")'>d1: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_d_i_s_t_a_n_c_e.html" style="color:green">DISTANCE</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg4d1"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_u_p_p_e_r__w_a_l_l_s.html" style="color:green">UPPER_WALLS</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<b name="eg4d1">d1</b> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg4"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Add the restraint on the distance between com and the second atom</span>
<b name="eg4d2" onclick='showPath("eg4","eg4d2")'>d2: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_d_i_s_t_a_n_c_e.html" style="color:green">DISTANCE</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg4d2"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_u_p_p_e_r__w_a_l_l_s.html" style="color:green">UPPER_WALLS</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg4"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Add the restraint on the distance between com and the third atom</span>
<b name="eg4d3" onclick='showPath("eg4","eg4d3")'>d3: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_d_i_s_t_a_n_c_e.html" style="color:green">DISTANCE</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg4d3"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_u_p_p_e_r__w_a_l_l_s.html" style="color:green">UPPER_WALLS</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg4"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Add the restraint on the distance between com and the fourth atom</span>
<b name="eg4d4" onclick='showPath("eg4","eg4d4")'>d4: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_d_i_s_t_a_n_c_e.html" style="color:green">DISTANCE</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg4d4"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_u_p_p_e_r__w_a_l_l_s.html" style="color:green">UPPER_WALLS</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg4"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Add the restraint on the distance between com and the fifth atom</span>
<b name="eg4d5" onclick='showPath("eg4","eg4d5")'>d5: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_d_i_s_t_a_n_c_e.html" style="color:green">DISTANCE</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg4d5"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_u_p_p_e_r__w_a_l_l_s.html" style="color:green">UPPER_WALLS</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg4"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Add the restraint on the distance between com and the sixth atom</span>
<b name="eg4d6" onclick='showPath("eg4","eg4d6")'>d6: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_d_i_s_t_a_n_c_e.html" style="color:green">DISTANCE</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg4d6"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_u_p_p_e_r__w_a_l_l_s.html" style="color:green">UPPER_WALLS</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg4"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Add the restraint on the distance between com and the seventh atom</span>
<b name="eg4d7" onclick='showPath("eg4","eg4d7")'>d7: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_d_i_s_t_a_n_c_e.html" style="color:green">DISTANCE</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg4d7"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_u_p_p_e_r__w_a_l_l_s.html" style="color:green">UPPER_WALLS</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg4"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Calculate the collective variables</span>
<b name="eg4c1" onclick='showPath("eg4","eg4c1")'>c1: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_c_o_o_r_d_i_n_a_t_i_o_n_n_u_m_b_e_r.html" style="color:green">COORDINATIONNUMBER</a> <div class="tooltip">SPECIES<div class="right">this keyword is used for colvars such as coordination number. <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">MOMENTS<div class="right">calculate the moments of the distribution of collective variables. <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">SWITCH<div class="right">This keyword is used if you want to employ an alternative to the continuous switching
function defined above. <i></i></div></div>={RATIONAL __FILL__ }  <span style="display:none;" id="eg4c1"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Do metadynamics</span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_m_e_t_a_d.html" style="color:green">METAD</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">HEIGHT<div class="right">the heights of the Gaussian hills. <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">PACE<div class="right"><b>compulsory keyword </b>
the frequency for hill addition <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">SIGMA<div class="right"><b>compulsory keyword </b>
the widths of the Gaussian hills <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">GRID_MIN<div class="right">the lower bounds for the grid <i></i></div></div>=-1.5,-1.5 <div class="tooltip">GRID_MAX<div class="right">the upper bounds for the grid <i></i></div></div>=2.5,2.5 <div class="tooltip">GRID_BIN<div class="right">the number of bins for the grid <i></i></div></div>=500,500 <div class="tooltip">BIASFACTOR<div class="right">use well tempered metadynamics and use this bias factor. <i></i></div></div>=5 <span style="display:none;" id="eg4"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
</pre>
<p><b> This input should be modified to instruct PLUMED to add Gaussian kernels with a bandwidth of 0.1 in both the second and third moment of the distribution of coordination numbers and a height of 0.05 \(\epsilon\) every 500 MD steps. The metadynamics calculation should then be run using simplemd at a temperature of \(k_B T = 0.1 \epsilon\). </b></p>
<p>You can then run a simplemd calculation using the following input:</p>
<pre class="fragment">inputfile input.xyz
outputfile output.xyz
temperature 0.1
tstep 0.005
friction 1
forcecutoff 2.5
listcutoff  3.0
ndim 2
nstep 1000000
nconfig 100 trajectory.xyz
nstat   1000 energies.dat
</pre><p>and the command</p>
<pre class="fragment">plumed simplemd &lt; in
</pre><h2><a class="anchor" id="lugano-4-post"></a>
Extracting block averages for the histogram</h2>
<p>Having now run the metadynamics we will need to post process our trajectory with <b> driver </b> in order to extract the free energy by reweighting. Furthermore, notice that, in order to do our block averaging, we are going to want to extract multiple estimates for the histogram so that we can do our block averaging. We are thus going to use the following input file to extract our estimates of the histogram:</p>

<div style="width: 90%; float:left" id="value_details_eg5"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.7-incomplete-yellow.svg" alt="tested on v2.7" /></div><pre style="width: 97%;" class="fragment">
<span style="color:blue"># this optional command tells VIM that this is a PLUMED file and to color the text accordingly</span>
<span style="color:blue"># vim: ft=plumed</span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_u_n_i_t_s.html" style="color:green">UNITS</a> <div class="tooltip">NATURAL<div class="right">( default=off ) use natural units <i></i></div></div> <span style="display:none;" id="eg5"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># We can delete the parts of the input that specified the walls and disregrad these in our analysis</span>
<span style="color:blue"># It is OK to do this as we are only interested in the value of the free energy in parts of phase space</span>
<span style="color:blue"># where the bias due to these walls is not acting.</span>
<b name="eg5c1" onclick='showPath("eg5","eg5c1")'>c1: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_c_o_o_r_d_i_n_a_t_i_o_n_n_u_m_b_e_r.html" style="color:green">COORDINATIONNUMBER</a> <div class="tooltip">SPECIES<div class="right">this keyword is used for colvars such as coordination number. <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">MOMENTS<div class="right">calculate the moments of the distribution of collective variables. <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">SWITCH<div class="right">This keyword is used if you want to employ an alternative to the continuous switching
function defined above. <i></i></div></div>={RATIONAL __FILL__}  <span style="display:none;" id="eg5c1"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># The metadynamics bias is restarted here so we consider the final bias as a static bias in our calculations</span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_m_e_t_a_d.html" style="color:green">METAD</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">HEIGHT<div class="right">the heights of the Gaussian hills. <i></i></div></div>=0.05 <div class="tooltip">PACE<div class="right"><b>compulsory keyword </b>
the frequency for hill addition <i></i></div></div>=50000000 <div class="tooltip">SIGMA<div class="right"><b>compulsory keyword </b>
the widths of the Gaussian hills <i></i></div></div>=0.1,0.1 <div class="tooltip">GRID_MIN<div class="right">the lower bounds for the grid <i></i></div></div>=-1.5,-1.5 <div class="tooltip">GRID_MAX<div class="right">the upper bounds for the grid <i></i></div></div>=2.5,2.5 <div class="tooltip">GRID_BIN<div class="right">the number of bins for the grid <i></i></div></div>=500,500 <div class="tooltip">TEMP<div class="right">the system temperature - this is only needed if you are doing well-tempered metadynamics
<i></i></div></div>=0.1 <div class="tooltip">BIASFACTOR<div class="right">use well tempered metadynamics and use this bias factor. <i></i></div></div>=5 <div class="tooltip">RESTART<div class="right">allows per-action setting of restart (YES/NO/AUTO) <i></i></div></div>=YES <span style="display:none;" id="eg5"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># This adjusts the weights of the sampled configurations and thereby accounts for the effect of the bias potential</span>
<b name="eg5rw" onclick='showPath("eg5","eg5rw")'>rw: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_r_e_w_e_i_g_h_t__b_i_a_s.html" style="color:green">REWEIGHT_BIAS</a> <div class="tooltip">TEMP<div class="right">the system temperature. <i></i></div></div>=0.1 <span style="display:none;" id="eg5rw"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Calculate the histogram and output it to a file</span>
<b name="eg5hh" onclick='showPath("eg5","eg5hh")'>hh: </b><a href="https://www.plumed.org/doc-v2.7/user-doc/html/_h_i_s_t_o_g_r_a_m.html" style="color:green">HISTOGRAM</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<b name="eg5c1">c1.*</b> <div class="tooltip">GRID_MIN<div class="right"><b>compulsory keyword </b>
the lower bounds for the grid <i></i></div></div>=-1.5,-1.5 <div class="tooltip">GRID_MAX<div class="right"><b>compulsory keyword </b>
the upper bounds for the grid <i></i></div></div>=2.5,2.5 <div class="tooltip">GRID_BIN<div class="right">the number of bins for the grid <i></i></div></div>=200,200 <div class="tooltip">BANDWIDTH<div class="right"><b>compulsory keyword </b>
the bandwidths for kernel density estimation <i></i></div></div>=0.02,0.02 <div class="tooltip">LOGWEIGHTS<div class="right">list of actions that calculates log weights that should be used to weight configurations
when calculating averages <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">CLEAR<div class="right"><b>compulsory keyword ( default=0 )</b>
the frequency with which to clear all the accumulated data. <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <span style="display:none;" id="eg5hh"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/_d_u_m_p_g_r_i_d.html" style="color:green">DUMPGRID</a> <div class="tooltip">GRID<div class="right"><b>compulsory keyword </b>
the action that creates the grid you would like to output <i></i></div></div>=<b name="eg5hh">hh</b> <div class="tooltip">FILE<div class="right"><b>compulsory keyword ( default=density )</b>
the file on which to write the grid. <i></i></div></div>=my_histogram.dat <div class="tooltip">STRIDE<div class="right"><b>compulsory keyword ( default=0 )</b>
the frequency with which the grid should be output to the file. <i></i></div></div>=2500 <span style="display:none;" id="eg5"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
</pre>
<p>Once you have filled in the blanks in this input you can then run the calculation by using the command:</p>
<pre class="fragment">&gt; plumed driver --ixyz trajectory.xyz  --initial-step 1
</pre><p>You must make sure that the HILLS file that was output by your metadynamics simulation is available in the directory where you run the above command. If that condition is satisfied though you should generate a number of files containing histograms that will be called: analysis.0.my_histogram.dat, analysis.1.myhistogram.dat etc. These files contain the histograms constructed from each of the blocks of data in your trajectory. You can merge them all to get the final free energy surface, which can be calculated using the well known relation between the histogram, \(P(s)\), and the free energy surface, \(F(s)\):</p>
<p class="formulaDsp">
\[ F(s) = - k_B T \ln P(s) \]
</p>
<p>that is employed in the following python script:</p>
<div class="fragment"><div class="line"><span class="keyword">import</span> math</div>
<div class="line"><span class="keyword">import</span> glob</div>
<div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Here are some numbers you will need to change if you run this script on grids generated in different contexts</span></div>
<div class="line">temp = 0.1               <span class="comment"># Boltzmann&#39;s constant multiplied by the temperature at which the simulation was performed </span></div>
<div class="line">grid_dimension = 2       <span class="comment"># Number of collective variables that you provided using the ARG keyword</span></div>
<div class="line">filename = <span class="stringliteral">&quot;my_histogram.dat&quot;</span>  <span class="comment"># The name you specified the data to output to in the DUMPGRID command</span></div>
<div class="line"> </div>
<div class="line"><span class="comment"># Function to read in histogram data and normalization</span></div>
<div class="line"><span class="keyword">def </span>readhistogram( fname ) :</div>
<div class="line">        <span class="comment"># Read in the histogram data</span></div>
<div class="line">        data = np.loadtxt( fname )</div>
<div class="line">        <span class="keyword">with</span> open( filename, <span class="stringliteral">&quot;r&quot;</span> ) <span class="keyword">as</span> myfile :</div>
<div class="line">                <span class="keywordflow">for</span> line <span class="keywordflow">in</span> myfile :</div>
<div class="line">                        <span class="keywordflow">if</span> line.startswith(<span class="stringliteral">&quot;#! SET normalisation&quot;</span>) : norm = line.split()[3]</div>
<div class="line">        <span class="keywordflow">return</span> float(norm), data</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Read in the grid file header to work out what fields we have</span></div>
<div class="line"><span class="keyword">with</span> open( filename, <span class="stringliteral">&quot;r&quot;</span> ) <span class="keyword">as</span> myfile :</div>
<div class="line">        <span class="keywordflow">for</span> line <span class="keywordflow">in</span> myfile :</div>
<div class="line">                <span class="keywordflow">if</span> line.startswith(<span class="stringliteral">&quot;#! FIELDS&quot;</span>) : fieldnames = line.split()</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Check if derivatives have been output in the grid by investigating the header</span></div>
<div class="line">nextg = 1</div>
<div class="line"><span class="keywordflow">if</span> len(fieldnames)&gt;(2+grid_dimension+1) :</div>
<div class="line">        nextg = 1 + grid_dimension</div>
<div class="line">        <span class="keyword">assert</span> len(fieldnames)==(2+grid_dimension + nextg)</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Read in a grid</span></div>
<div class="line">norm, griddata = readhistogram( filename )</div>
<div class="line">norm2 = norm*norm</div>
<div class="line"><span class="comment"># Create two np array that will be used to accumulate the average grid and the average grid squared</span></div>
<div class="line">average = np.zeros( len(griddata[:,0]) )</div>
<div class="line">average_sq = np.zeros( len(griddata[:,0]) )</div>
<div class="line">average[:] = norm*griddata[:, grid_dimension]</div>
<div class="line">average_sq[:] = norm*griddata[:, grid_dimension]*griddata[:, grid_dimension]</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Now sum the grids from all all the analysis files you have</span></div>
<div class="line"><span class="keywordflow">for</span> filen <span class="keywordflow">in</span> glob.glob( <span class="stringliteral">&quot;analysis.*.&quot;</span> + filename ) :</div>
<div class="line">        tnorm, newgrid = readhistogram( filen )</div>
<div class="line">        norm = norm + tnorm</div>
<div class="line">        norm2 = norm2 + tnorm*tnorm</div>
<div class="line">        average[:] = average[:] + tnorm*newgrid[:, grid_dimension]</div>
<div class="line">        average_sq[:] = average_sq[:] + tnorm*newgrid[:, grid_dimension]*newgrid[:, grid_dimension]</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Compte the final average grid</span></div>
<div class="line">average = average / norm</div>
<div class="line"><span class="comment"># Compute the sample variance for all grid points</span></div>
<div class="line">variance = (average_sq / norm) - average*average</div>
<div class="line"><span class="comment"># Now multiply by bessel correction to unbias the sample variance and get the population variance</span></div>
<div class="line">variance = ( norm /(norm-(norm2/norm)) ) * variance</div>
<div class="line"><span class="comment"># And lastly divide by number of grids and square root to get an error bar for each grid point</span></div>
<div class="line">ngrid = 1 + len( glob.glob( <span class="stringliteral">&quot;analysis.*.&quot;</span> + filename ) )</div>
<div class="line">errors = np.sqrt( variance / ngrid )</div>
<div class="line">mean_error, denom = 0, 0</div>
<div class="line"><span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(errors)) :</div>
<div class="line">        <span class="keywordflow">if</span> np.abs(average[i])&gt;0 :</div>
<div class="line">                errors[i] = errors[i] / average[i]</div>
<div class="line">                mean_error = mean_error + errors[i]</div>
<div class="line">                denom = denom + 1</div>
<div class="line">        <span class="keywordflow">else</span> : errors[i] = 0</div>
<div class="line"><span class="comment"># Calculate average error over grid and output in header</span></div>
<div class="line">mean_error = mean_error / denom</div>
<div class="line">print(<span class="stringliteral">&quot;# Average error for free energy on grid equals &quot;</span>, mean_error )</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Output the final free energy</span></div>
<div class="line"><span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(0,len(griddata[:,0])) :</div>
<div class="line">        <span class="keywordflow">for</span> j <span class="keywordflow">in</span> range(0,grid_dimension) : print( griddata[i,j], end=<span class="stringliteral">&quot; &quot;</span> )</div>
<div class="line">        print( -temp*np.log(average[i]), temp*errors[i] )</div>
<div class="line">        <span class="comment"># We added spaces every time the y coordinate changes value to make the output readable by gnuplot</span></div>
<div class="line">        <span class="keywordflow">if</span> i%201==0 <span class="keywordflow">and</span> i&gt;0 : print()</div>
</div><!-- fragment --><p>Copy this script to a file called merge-histograms.py and then run it on your data by executing the command:</p>
<pre class="fragment">&gt; python merge-histograms.py &gt; final-histogram.dat
</pre><p>This will output the final average histogram together with some error bars. You can plot the free energy surface you obtain by using gnuplot and the following command:</p>
<pre class="fragment">gnuplot&gt; sp 'final-histogram.dat' u 1:2:3 w pm3d
</pre><p>Similarly you can get a sense of how the error in the estimate of the free energy depends on the value of the CV by using the command:</p>
<pre class="fragment">gnuplot&gt; sp 'final-histogram.dat' u 1:2:4 w pm3d
</pre><p>More usefully, however, if you open the final-histogram.dat file you find that the first line reads:</p>
<pre class="fragment"># Average error for historgram is &lt;average-histogram-error&gt; and thus average energy in free energy is &lt;average-free-energy-error&gt;
</pre><p>You can thus read off the average error in the estimate of the free energy from this top line directly.</p>
<p><b> Repeat the analysis of the trajectory that was discussed in this section with different block sizes. Use the results you obtain to draw a graph showing how the average error on the estimate of the free energy depends on the block size </b></p>
<p> <details> <summary> <b> To learn more: Expected result </b> </summary> <div class="hidden">  You should be able to extract a graph that looks something like the one shown below. The error is small when the block size is small because the correlations between the trajectory frames cause this quantity to be underestimated. As the block size increases, however, the error increases until it eventually flattens out.</p>
<p><a class="anchor" id="lugano-4-lj7-errors"></a></p><div class="image">
<img src="lugano-4-lj7-errors.png" alt=""/>
<div class="caption">
The error in the estimate of the free energy as a function of the size of the blocks.</div></div>
<p> </div> </details> </p>
<h1><a class="anchor" id="lugano-4-extensions"></a>
Conclusions and extensions</h1>
<p>This exercise has explained the block averaging technique and has shown you how this technique can be used to extract the errors in estimates of the free energy. You can learn more about the background to this technique and the business of reweighting biased trajectories in particular by working through <a class="el" href="trieste-2.html">Trieste tutorial: Averaging, histograms and block analysis</a> or by reading <a href="https://arxiv.org/abs/1812.08213">https://arxiv.org/abs/1812.08213</a>. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.3.1-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
<!--    <li class="navelem"><a class="el" href="tutorials.html">Tutorials</a></li>  -->
    <li class="footer">   <!--- Generated by -->
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
